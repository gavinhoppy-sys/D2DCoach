<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>D2D Roofing Sales Coach</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f0f2f5;
      height: 100vh; height: 100dvh;
      display: flex; flex-direction: column; overflow: hidden;
    }

    /* â”€â”€ Header â”€â”€ */
    .header {
      background: #1a1a2e; color: white;
      padding: 10px 14px;
      display: flex; justify-content: space-between; align-items: center; gap: 10px;
      flex-shrink: 0;
    }
    .header-title h1 { font-size: 16px; font-weight: 700; }
    .header-title p  { font-size: 11px; opacity: 0.55; margin-top: 2px; }
    .header-actions  { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }

    .icon-btn {
      background: rgba(255,255,255,0.15); color: white; border: none;
      width: 34px; height: 34px; border-radius: 50%; font-size: 16px;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
    }
    .icon-btn:hover { background: rgba(255,255,255,0.25); }

    .stop-conv-btn {
      background: rgba(239,68,68,0.25); color: #fca5a5; border: none;
      padding: 5px 12px; border-radius: 14px; font-size: 12px; font-weight: 600;
      cursor: pointer; display: none; align-items: center; gap: 5px;
    }
    .stop-conv-btn.visible { display: flex; }
    .stop-conv-btn:hover { background: rgba(239,68,68,0.4); }

    .hub-link {
      color: rgba(255,255,255,0.8); text-decoration: none;
      font-size: 13px; font-weight: 600;
      padding: 5px 10px; border-radius: 12px;
      background: rgba(255,255,255,0.12);
      white-space: nowrap;
    }
    .hub-link:hover { background: rgba(255,255,255,0.22); color: white; }

    .end-btn {
      background: #e74c3c; color: white; border: none;
      padding: 7px 14px; border-radius: 18px; font-size: 13px; font-weight: 600;
      cursor: pointer; white-space: nowrap;
    }
    .end-btn:hover:not(:disabled) { background: #c0392b; }
    .end-btn:disabled { background: #666; cursor: not-allowed; }

    /* â”€â”€ Chat â”€â”€ */
    .chat-area {
      flex: 1; overflow-y: auto;
      padding: 14px 12px; display: flex; flex-direction: column; gap: 10px;
    }

    .welcome {
      background: #e8eaf6; border-radius: 12px; padding: 16px;
      text-align: center; color: #3730a3; font-size: 14px; line-height: 1.55;
    }
    .welcome strong { display: block; font-size: 16px; margin-bottom: 6px; }

    /* Rep bubbles */
    .rep-label { align-self: flex-end; font-size: 11px; color: #888; padding-right: 4px; }
    .rep-wrap  { align-self: flex-end; max-width: 78%; display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
    .rep-bubble {
      background: #0084ff; color: white;
      padding: 10px 14px; border-radius: 18px 18px 4px 18px;
      font-size: 15px; line-height: 1.45; word-wrap: break-word;
    }
    .rep-metrics { font-size: 11px; color: #888; padding-right: 4px; }

    /* Live preview (ghost bubble while speaking) */
    .live-preview {
      align-self: flex-end; max-width: 78%;
      background: rgba(0,132,255,0.1);
      border: 1.5px dashed rgba(0,132,255,0.35);
      color: #374151; padding: 10px 14px;
      border-radius: 18px 18px 4px 18px;
      font-size: 15px; font-style: italic; word-wrap: break-word; min-width: 48px;
    }

    /* Homeowner bubbles */
    .hw-group { display: flex; flex-direction: column; gap: 6px; }
    .hw-bubble {
      align-self: flex-start; max-width: 78%;
      background: white; color: #111;
      padding: 10px 14px; border-radius: 18px 18px 18px 4px;
      font-size: 15px; line-height: 1.45;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1); word-wrap: break-word;
    }
    .coach-note {
      background: #fffbeb; border-left: 3px solid #f59e0b;
      border-radius: 0 8px 8px 0; padding: 9px 13px;
      font-size: 13.5px; color: #78350f; line-height: 1.5; word-wrap: break-word;
    }
    .coach-tag {
      display: inline-block; background: #f59e0b; color: white;
      font-size: 10px; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.6px; padding: 2px 7px; border-radius: 10px; margin-bottom: 5px;
    }

    /* Scorecard */
    .scorecard { background: white; border-radius: 14px; padding: 20px; box-shadow: 0 2px 12px rgba(0,0,0,0.12); border: 2px solid #6366f1; }
    .scorecard h2 { font-size: 17px; color: #4338ca; margin-bottom: 16px; text-align: center; }
    .score-row { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 11px; }
    .score-badge { background: #6366f1; color: white; font-size: 13px; font-weight: 700; padding: 4px 10px; border-radius: 12px; white-space: nowrap; flex-shrink: 0; margin-top: 1px; }
    .score-body .score-cat  { font-weight: 600; font-size: 14px; color: #111; }
    .score-body .score-text { font-size: 13px; color: #555; margin-top: 2px; line-height: 1.4; }
    .overall-row { margin-top: 14px; padding-top: 14px; border-top: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: center; gap: 14px; }
    .overall-label { font-weight: 700; font-size: 15px; }
    .overall-badge { background: #059669; color: white; font-size: 22px; font-weight: 800; padding: 6px 20px; border-radius: 20px; }
    .scorecard-raw { font-size: 14px; color: #444; line-height: 1.6; white-space: pre-wrap; }

    /* Typing indicator */
    .typing { display: flex; gap: 5px; align-items: center; padding: 10px 14px; background: white; border-radius: 18px 18px 18px 4px; align-self: flex-start; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .dot { width: 8px; height: 8px; background: #aaa; border-radius: 50%; animation: bounce 1.2s infinite; }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce { 0%,60%,100%{transform:translateY(0)} 30%{transform:translateY(-6px)} }

    .error-msg { background: #fee2e2; border-radius: 8px; padding: 10px 14px; color: #991b1b; font-size: 13px; }

    /* â”€â”€ Conversation bar â”€â”€ */
    .conv-bar {
      background: white; border-top: 1px solid #e5e7eb;
      padding: 12px 16px 20px; flex-shrink: 0;
      display: flex; flex-direction: column; gap: 10px;
      padding-bottom: max(20px, env(safe-area-inset-bottom));
    }

    /* Status bar */
    .status-bar {
      display: flex; align-items: center; justify-content: center;
      gap: 8px; min-height: 22px;
      font-size: 14px; font-weight: 500; color: #6b7280;
    }
    .status-bar.listening { color: #dc2626; }
    .status-bar.speaking  { color: #059669; }
    .status-bar.processing { color: #6366f1; }

    /* Main conversation button */
    .conv-main-btn {
      width: 100%; padding: 15px; border-radius: 14px; border: none;
      font-size: 16px; font-weight: 600; cursor: pointer;
      transition: background 0.15s, transform 0.1s;
    }
    .conv-main-btn:active { transform: scale(0.98); }
    .conv-main-btn.idle       { background: #0084ff; color: white; }
    .conv-main-btn.idle:hover { background: #006edb; }
    .conv-main-btn.send-now   { background: #fef2f2; color: #dc2626; border: 2px solid #fecaca; }
    .conv-main-btn.send-now:hover { background: #fee2e2; }
    .conv-main-btn.interrupt  { background: #f0fdf4; color: #059669; border: 2px solid #bbf7d0; }
    .conv-main-btn.interrupt:hover { background: #dcfce7; }
    .conv-main-btn:disabled   { background: #f3f4f6; color: #9ca3af; cursor: not-allowed; transform: none; }

    /* Waveform animations */
    .wave-bars { display: flex; align-items: center; gap: 3px; height: 18px; }
    .wave-bar  { width: 3px; border-radius: 2px; animation: wavebar 0.9s ease-in-out infinite; }
    .wave-bar:nth-child(1) { animation-delay: 0.0s; height: 7px; }
    .wave-bar:nth-child(2) { animation-delay: 0.15s; height: 13px; }
    .wave-bar:nth-child(3) { animation-delay: 0.3s;  height: 18px; }
    .wave-bar:nth-child(4) { animation-delay: 0.15s; height: 13px; }
    .wave-bar:nth-child(5) { animation-delay: 0.0s;  height: 7px; }
    @keyframes wavebar { 0%,100%{transform:scaleY(0.4)} 50%{transform:scaleY(1)} }
    .wave-bar.red   { background: #dc2626; }
    .wave-bar.green { background: #059669; }

    /* Spinner */
    .spinner {
      width: 18px; height: 18px; border-radius: 50%;
      border: 2px solid #c7d2fe; border-top-color: #6366f1;
      animation: spin 0.7s linear infinite; flex-shrink: 0;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Text fallback (non-voice browsers) */
    .text-fallback {
      display: none; gap: 8px; align-items: flex-end;
    }
    .text-fallback textarea {
      flex: 1; border: 1.5px solid #d1d5db; border-radius: 12px;
      padding: 10px 14px; font-size: 15px; line-height: 1.4;
      resize: none; outline: none; font-family: inherit;
    }
    .text-fallback textarea:focus { border-color: #0084ff; }
    .send-text-btn {
      background: #0084ff; color: white; border: none;
      padding: 10px 18px; border-radius: 12px; font-size: 15px;
      font-weight: 600; cursor: pointer;
    }

    .new-session-area { text-align: center; padding: 6px 0 2px; }
    .new-btn { background: none; border: 1.5px solid #6366f1; color: #6366f1; padding: 7px 20px; border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer; }
    .new-btn:hover { background: #ede9fe; }

    /* â”€â”€ Name modal â”€â”€ */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.55);
      display: flex; align-items: center; justify-content: center;
      z-index: 100; padding: 20px;
    }
    .modal-overlay.hidden { display: none; }
    .modal-box {
      background: white; border-radius: 20px; padding: 32px 28px;
      max-width: 360px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.25);
      text-align: center;
    }
    .modal-box h2 { font-size: 22px; color: #1a1a2e; margin-bottom: 8px; }
    .modal-box p  { font-size: 14px; color: #6b7280; margin-bottom: 24px; line-height: 1.5; }
    .modal-input {
      width: 100%; border: 1.5px solid #d1d5db; border-radius: 12px;
      padding: 12px 16px; font-size: 16px; outline: none; font-family: inherit;
      margin-bottom: 16px;
    }
    .modal-input:focus { border-color: #6366f1; }
    .modal-submit {
      width: 100%; background: #6366f1; color: white; border: none;
      padding: 13px; border-radius: 12px; font-size: 16px; font-weight: 700;
      cursor: pointer;
    }
    .modal-submit:hover { background: #4f46e5; }

    /* â”€â”€ Coach summary card â”€â”€ */
    .coach-summary {
      background: linear-gradient(135deg, #1a1a2e, #16213e);
      color: white; border-radius: 16px; padding: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    .coach-summary h3 { font-size: 14px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.6; margin-bottom: 14px; }
    .cs-score { font-size: 52px; font-weight: 900; text-align: center; margin-bottom: 4px; }
    .cs-score.red    { color: #ef4444; }
    .cs-score.orange { color: #fb923c; }
    .cs-score.green  { color: #34d399; }
    .cs-score.gold   { color: #fbbf24; }
    .cs-label { text-align: center; font-size: 12px; opacity: 0.5; margin-bottom: 16px; }
    .cs-summary { font-size: 14px; line-height: 1.55; opacity: 0.85; margin-bottom: 16px; }
    .cs-row { display: flex; gap: 10px; margin-top: 10px; }
    .cs-box { flex: 1; background: rgba(255,255,255,0.08); border-radius: 10px; padding: 12px; }
    .cs-box-title { font-size: 10px; text-transform: uppercase; letter-spacing: 0.6px; opacity: 0.5; margin-bottom: 6px; }
    .cs-box-text  { font-size: 13px; line-height: 1.4; }
  </style>
</head>
<body>

<!-- Rep name modal -->
<div class="modal-overlay" id="nameModal">
  <div class="modal-box">
    <h2>Welcome! ğŸ‘‹</h2>
    <p>Enter your name so we can track your progress over time.</p>
    <input class="modal-input" id="nameInput" type="text" placeholder="Your first name" maxlength="40"
      onkeydown="if(event.key==='Enter') submitName()">
    <button class="modal-submit" onclick="submitName()">Let's Practice</button>
  </div>
</div>

<div class="header">
  <div class="header-title">
    <h1>D2D Roofing Sales Coach</h1>
    <p id="repNameDisplay">Real-time voice practice</p>
  </div>
  <div class="header-actions">
    <a href="/hub.html" class="hub-link">ğŸ“‹ Hub</a>
    <button class="icon-btn" id="voiceBtn" onclick="toggleTTS()" title="Mute homeowner voice">ğŸ”Š</button>
    <button class="stop-conv-btn" id="stopConvBtn" onclick="stopConversation()">â–  Stop</button>
    <button class="end-btn" id="endBtn" onclick="endSession()">End Session</button>
  </div>
</div>

<div class="chat-area" id="chatArea">
  <div class="welcome">
    <strong>Welcome, Sales Rep!</strong>
    Tap <strong>Start Conversation</strong> â€” the mic opens, you pitch, and Claude responds as the homeowner.
    Your pace, energy, and delivery are analyzed after each turn.
  </div>
</div>

<div class="conv-bar">
  <div class="status-bar" id="statusBar"></div>
  <button class="conv-main-btn idle" id="mainBtn" onclick="handleMainBtn()">
    â–¶ Start Conversation
  </button>
  <!-- Text-only fallback for browsers without Web Speech API -->
  <div class="text-fallback" id="textFallback">
    <textarea id="msgInput" placeholder="Type your pitchâ€¦" rows="2"
      onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendTextMessage();}"></textarea>
    <button class="send-text-btn" onclick="sendTextMessage()">Send</button>
  </div>
</div>

<script>
  // â”€â”€ Rep name â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let repName = localStorage.getItem('d2d_rep_name') || '';

  function submitName() {
    const val = document.getElementById('nameInput').value.trim();
    if (!val) return;
    repName = val;
    localStorage.setItem('d2d_rep_name', repName);
    document.getElementById('nameModal').classList.add('hidden');
    document.getElementById('repNameDisplay').textContent = 'Hey, ' + repName + ' ğŸ‘‹';
  }

  // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // convState: 'idle' | 'listening' | 'processing' | 'speaking' | 'ended'
  let convState  = 'idle';
  let ttsEnabled = true;

  // Session tracking
  let sessionStartTime = null;
  let repMessageCount  = 0;

  let sendDebounce    = null;
  let currentTranscript = '';

  // Audio analysis
  let audioCtx = null, analyser = null, micStream = null, analysisInterval = null;
  let energySamples = [], freqSamples = [], recordStart = 0;

  // Speech recognition
  const hasSpeech = !!(window.SpeechRecognition || window.webkitSpeechRecognition);
  let recognition = null;

  // TTS voices
  let voices = [];
  if (window.speechSynthesis) {
    speechSynthesis.onvoiceschanged = () => { voices = speechSynthesis.getVoices(); };
    setTimeout(() => { voices = speechSynthesis.getVoices(); }, 300);
  }

  // â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  (function boot() {
    // Show name modal if name not set
    if (!repName) {
      document.getElementById('nameModal').classList.remove('hidden');
      setTimeout(() => document.getElementById('nameInput').focus(), 100);
    } else {
      document.getElementById('nameModal').classList.add('hidden');
      document.getElementById('repNameDisplay').textContent = 'Hey, ' + repName + ' ğŸ‘‹';
    }

    if (hasSpeech) {
      setupRecognition();
      document.getElementById('textFallback').style.display = 'none';
    } else {
      document.getElementById('textFallback').style.display = 'flex';
      document.getElementById('mainBtn').style.display = 'none';
      document.getElementById('statusBar').style.display = 'none';
      document.getElementById('voiceBtn').style.display = 'none';
    }
  })();

  // â”€â”€ Speech recognition setup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setupRecognition() {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SR();
    recognition.continuous     = true;
    recognition.interimResults = true;
    recognition.lang           = 'en-US';

    recognition.onresult = (e) => {
      let final = '', interim = '';
      for (let i = 0; i < e.results.length; i++) {
        e.results[i].isFinal
          ? (final  += e.results[i][0].transcript + ' ')
          : (interim += e.results[i][0].transcript);
      }
      currentTranscript = (final + interim).trim();
      updateLivePreview(currentTranscript);

      // After final speech (â‰¥2 words), arm a 2-second auto-send timer
      if (e.results[e.results.length - 1].isFinal) {
        const wordCount = final.trim().split(/\s+/).filter(Boolean).length;
        if (wordCount >= 2) {
          clearTimeout(sendDebounce);
          sendDebounce = setTimeout(() => {
            if (convState === 'listening') triggerAutoSend();
          }, 4000);
        }
      }
    };

    recognition.onerror = (e) => {
      if (e.error !== 'no-speech' && e.error !== 'aborted') {
        console.error('SR error:', e.error);
      }
    };

    // Chrome stops after ~60 s silence â€” restart while still listening
    recognition.onend = () => {
      if (convState === 'listening') {
        try { recognition.start(); } catch (_) {}
      }
    };
  }

  // â”€â”€ Main button handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function handleMainBtn() {
    switch (convState) {
      case 'idle':      startConversation();  break;
      case 'listening': triggerAutoSend();    break;   // send now
      case 'speaking':  interruptHomeowner(); break;   // cut off TTS
    }
  }

  // â”€â”€ Conversation lifecycle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function startConversation() {
    if (convState !== 'idle') return;
    sessionStartTime = Date.now();
    repMessageCount  = 0;
    setConvState('listening');
    await openMic();
  }

  function stopConversation() {
    clearTimeout(sendDebounce);
    if (window.speechSynthesis) speechSynthesis.cancel();
    closeMic();
    clearLivePreview();
    currentTranscript = '';
    setConvState('idle');
  }

  function interruptHomeowner() {
    if (window.speechSynthesis) speechSynthesis.cancel();
    setConvState('listening');
    openMic();
  }

  // â”€â”€ Mic open / close â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function openMic() {
    try {
      micStream = await navigator.mediaDevices.getUserMedia({
        audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true },
        video: false,
      });
    } catch (_) {
      alert('Microphone access denied. Please allow it in your browser settings.');
      setConvState('idle');
      return;
    }

    audioCtx = new AudioContext();
    analyser = audioCtx.createAnalyser();
    analyser.fftSize = 2048;
    audioCtx.createMediaStreamSource(micStream).connect(analyser);

    energySamples = []; freqSamples = [];
    recordStart = Date.now();
    currentTranscript = '';

    try { recognition.start(); } catch (_) {}
    analysisInterval = setInterval(sampleAudio, 150);
  }

  function closeMic() {
    clearInterval(analysisInterval);
    try { recognition.stop(); } catch (_) {}
    if (micStream) { micStream.getTracks().forEach(t => t.stop()); micStream = null; }
    if (audioCtx)  { audioCtx.close().catch(() => {}); audioCtx = null; }
    analyser = null;
  }

  // â”€â”€ Audio sampling (for metrics) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function sampleAudio() {
    if (!analyser) return;

    // RMS energy
    const td = new Float32Array(analyser.fftSize);
    analyser.getFloatTimeDomainData(td);
    const rms = Math.sqrt(td.reduce((s, v) => s + v * v, 0) / td.length);
    if (rms > 0.003) energySamples.push(rms);

    // Dominant frequency in vocal range (80â€“1000 Hz)
    const fd     = new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(fd);
    const binHz  = (audioCtx ? audioCtx.sampleRate : 44100) / analyser.fftSize;
    const minBin = Math.floor(80   / binHz);
    const maxBin = Math.min(Math.floor(1000 / binHz), fd.length - 1);
    let maxVal = 0, maxIdx = 0;
    for (let i = minBin; i <= maxBin; i++) {
      if (fd[i] > maxVal) { maxVal = fd[i]; maxIdx = i; }
    }
    if (maxVal > 20) freqSamples.push(maxIdx * binHz);
  }

  // â”€â”€ Auto-send trigger â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function triggerAutoSend() {
    clearTimeout(sendDebounce);
    const text = currentTranscript.trim();
    if (!text || convState !== 'listening') return;

    const duration = (Date.now() - recordStart) / 1000;
    const metrics  = buildMetrics(text, duration);

    closeMic();
    clearLivePreview();
    currentTranscript = '';

    setConvState('processing');
    sendToServer(text, metrics);
  }

  // â”€â”€ Send to Claude â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function sendToServer(text, metrics) {
    const fullMsg = metrics ? `${text}\n\n[Voice: ${metrics}]` : text;

    repMessageCount++;
    appendRepMsg(text, metrics);
    showTyping();

    try {
      const res  = await fetch('/chat', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: fullMsg }),
      });
      const data = await res.json();
      removeTyping();

      if (data.error) {
        showError(data.error);
        setConvState('idle');
      } else {
        appendHomeownerResponse(data.response);
        setConvState('speaking');
        speakHomeowner(data.response);
      }
    } catch (_) {
      removeTyping();
      showError('Could not reach the server.');
      setConvState('idle');
    }
  }

  // â”€â”€ Metrics calculation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function buildMetrics(transcript, duration) {
    const words = transcript.split(/\s+/).filter(w => w.length > 0);
    const wpm   = duration > 1 ? Math.round((words.length / duration) * 60) : 0;

    let energy = '';
    if (energySamples.length > 0) {
      const avg = energySamples.reduce((a, b) => a + b, 0) / energySamples.length;
      energy = avg < 0.025 ? 'Soft energy' : avg < 0.06 ? 'Moderate energy' : 'Strong energy';
    }

    let pitch = '';
    if (freqSamples.length > 5) {
      const mean   = freqSamples.reduce((a, b) => a + b, 0) / freqSamples.length;
      const stdDev = Math.sqrt(freqSamples.reduce((s, v) => s + (v - mean) ** 2, 0) / freqSamples.length);
      pitch = stdDev < 35 ? 'Monotone' : stdDev < 85 ? 'Natural variation' : 'Dynamic pitch';
    }

    const fillers = (transcript.match(/\b(um+|uh+|like|you know|basically|literally|right\?|so+)\b/gi) || []).length;

    const parts = [];
    if (wpm > 0)      parts.push(`${wpm} WPM`);
    if (energy)       parts.push(energy);
    if (pitch)        parts.push(pitch);
    if (fillers > 0)  parts.push(`${fillers} filler word${fillers !== 1 ? 's' : ''}`);
    if (duration > 0) parts.push(`${Math.round(duration)}s`);
    return parts.join(' Â· ');
  }

  // â”€â”€ TTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function speakHomeowner(rawText) {
    const coachIdx = rawText.indexOf('COACH:');
    const text = (coachIdx !== -1 ? rawText.slice(0, coachIdx) : rawText).trim();

    const resume = () => {
      if (convState === 'speaking') {
        setTimeout(() => {
          setConvState('listening');
          openMic();
        }, 500);
      }
    };

    if (!text || !ttsEnabled || !window.speechSynthesis) {
      resume();
      return;
    }

    speechSynthesis.cancel();
    const utt = new SpeechSynthesisUtterance(text);
    utt.rate = 0.92; utt.pitch = 1.0;

    const preferred =
      voices.find(v => v.name === 'Google UK English Female') ||
      voices.find(v => v.name === 'Google US English')        ||
      voices.find(v => v.name === 'Microsoft Zira - English (United States)') ||
      voices.find(v => v.lang.startsWith('en') && /natural|neural|online/i.test(v.name)) ||
      voices.find(v => v.lang === 'en-US') ||
      voices.find(v => v.lang.startsWith('en'));
    if (preferred) utt.voice = preferred;

    utt.onend = resume;
    utt.onerror = resume;
    speechSynthesis.speak(utt);
  }

  function toggleTTS() {
    ttsEnabled = !ttsEnabled;
    const btn = document.getElementById('voiceBtn');
    btn.textContent = ttsEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
    if (!ttsEnabled && window.speechSynthesis) {
      speechSynthesis.cancel();
      if (convState === 'speaking') {
        setConvState('listening');
        openMic();
      }
    }
  }

  // â”€â”€ Conversation state UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setConvState(state) {
    convState = state;
    const statusEl  = document.getElementById('statusBar');
    const btn       = document.getElementById('mainBtn');
    const stopBtn   = document.getElementById('stopConvBtn');
    const endBtn    = document.getElementById('endBtn');

    const waveBars = (color) => `
      <div class="wave-bars">
        <div class="wave-bar ${color}"></div><div class="wave-bar ${color}"></div>
        <div class="wave-bar ${color}"></div><div class="wave-bar ${color}"></div>
        <div class="wave-bar ${color}"></div>
      </div>`;

    const inConv = state !== 'idle' && state !== 'ended';
    stopBtn.classList.toggle('visible', inConv);
    endBtn.disabled = state === 'processing';

    switch (state) {
      case 'idle':
        statusEl.innerHTML = '';
        statusEl.className = 'status-bar';
        btn.textContent = 'â–¶ Start Conversation';
        btn.className   = 'conv-main-btn idle';
        btn.disabled    = false;
        break;

      case 'listening':
        statusEl.innerHTML = `${waveBars('red')} <span>Listeningâ€¦</span>`;
        statusEl.className = 'status-bar listening';
        btn.textContent = 'â Send Now';
        btn.className   = 'conv-main-btn send-now';
        btn.disabled    = false;
        break;

      case 'processing':
        statusEl.innerHTML = '<div class="spinner"></div><span>Processingâ€¦</span>';
        statusEl.className = 'status-bar processing';
        btn.textContent = 'Processingâ€¦';
        btn.className   = 'conv-main-btn';
        btn.disabled    = true;
        break;

      case 'speaking':
        statusEl.innerHTML = `${waveBars('green')} <span>Homeowner speakingâ€¦</span>`;
        statusEl.className = 'status-bar speaking';
        btn.textContent = 'â­ Interrupt';
        btn.className   = 'conv-main-btn interrupt';
        btn.disabled    = false;
        break;

      case 'ended':
        statusEl.innerHTML = '';
        statusEl.className = 'status-bar';
        btn.textContent = 'Session Ended';
        btn.className   = 'conv-main-btn';
        btn.disabled    = true;
        break;
    }
  }

  // â”€â”€ Live preview bubble â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updateLivePreview(text) {
    let el = document.getElementById('livePreview');
    if (!el) {
      el = document.createElement('div');
      el.id = 'livePreview';
      el.className = 'live-preview';
      document.getElementById('chatArea').appendChild(el);
    }
    el.textContent = text || 'â€¦';
    scrollBottom();
  }
  function clearLivePreview() {
    const el = document.getElementById('livePreview');
    if (el) el.remove();
  }

  // â”€â”€ Text fallback (non-voice) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function sendTextMessage() {
    const input = document.getElementById('msgInput');
    const text  = (input.value || '').trim();
    if (!text) return;
    input.value = '';

    appendRepMsg(text, '');
    showTyping();

    try {
      const res  = await fetch('/chat', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: text }),
      });
      const data = await res.json();
      removeTyping();
      if (data.error) showError(data.error);
      else appendHomeownerResponse(data.response);
    } catch (_) {
      removeTyping();
      showError('Could not reach the server.');
    }
  }

  // â”€â”€ DOM helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function esc(t) {
    return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }
  function scrollBottom() {
    const c = document.getElementById('chatArea');
    c.scrollTop = c.scrollHeight;
  }

  function appendRepMsg(text, metrics) {
    const chat = document.getElementById('chatArea');
    const lbl  = document.createElement('div');
    lbl.className = 'rep-label'; lbl.textContent = 'You';
    const wrap = document.createElement('div'); wrap.className = 'rep-wrap';
    const bub  = document.createElement('div'); bub.className = 'rep-bubble'; bub.textContent = text;
    wrap.appendChild(bub);
    if (metrics) {
      const m = document.createElement('div');
      m.className = 'rep-metrics'; m.textContent = 'ğŸ¤ ' + metrics;
      wrap.appendChild(m);
    }
    chat.appendChild(lbl); chat.appendChild(wrap);
    scrollBottom();
  }

  function appendHomeownerResponse(raw) {
    const chat     = document.getElementById('chatArea');
    const coachIdx = raw.indexOf('COACH:');
    const hwText   = coachIdx !== -1 ? raw.slice(0, coachIdx).trim() : raw.trim();
    const coachTxt = coachIdx !== -1 ? raw.slice(coachIdx + 6).trim() : null;

    const group = document.createElement('div'); group.className = 'hw-group';
    const bub   = document.createElement('div'); bub.className = 'hw-bubble'; bub.textContent = hwText;
    group.appendChild(bub);
    if (coachTxt) {
      const note = document.createElement('div'); note.className = 'coach-note';
      note.innerHTML = `<span class="coach-tag">Coach</span><div>${esc(coachTxt)}</div>`;
      group.appendChild(note);
    }
    chat.appendChild(group); scrollBottom();
  }

  function showTyping() {
    const chat = document.getElementById('chatArea');
    const el   = document.createElement('div');
    el.className = 'typing'; el.id = 'typing';
    el.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
    chat.appendChild(el); scrollBottom();
  }
  function removeTyping() { const el = document.getElementById('typing'); if (el) el.remove(); }

  function showError(msg) {
    const chat = document.getElementById('chatArea');
    const el   = document.createElement('div');
    el.className = 'error-msg'; el.textContent = 'Error: ' + msg;
    chat.appendChild(el); scrollBottom();
  }

  // â”€â”€ End session / scorecard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function endSession() {
    if (convState === 'ended') return;

    clearTimeout(sendDebounce);
    if (window.speechSynthesis) speechSynthesis.cancel();
    closeMic();
    clearLivePreview();

    setConvState('ended');
    document.getElementById('endBtn').disabled = true;

    showTyping();
    try {
      const sessionDuration = sessionStartTime ? Math.round((Date.now() - sessionStartTime) / 1000) : 0;

      // Run scorecard display + deep analysis in parallel
      const [scorecardRes, analyzeRes] = await Promise.all([
        fetch('/scorecard', { method: 'POST', headers: { 'Content-Type': 'application/json' } }),
        fetch('/analyze',   { method: 'POST', headers: { 'Content-Type': 'application/json' } }),
      ]);
      const [scorecardData, analyzeData] = await Promise.all([scorecardRes.json(), analyzeRes.json()]);
      removeTyping();

      if (scorecardData.scorecard) appendScorecard(scorecardData.scorecard);
      else showError(scorecardData.error || 'Failed to generate scorecard.');

      if (analyzeData.analysis) {
        appendCoachSummary(analyzeData.analysis);
        speakCoachFeedback(analyzeData.analysis);
        saveSession(analyzeData.analysis, sessionDuration);
      }
    } catch (_) {
      removeTyping();
      showError('Could not reach the server.');
    }

    const chat = document.getElementById('chatArea');
    const area = document.createElement('div');
    area.className = 'new-session-area';
    area.innerHTML = '<button class="new-btn" onclick="newSession()">Start New Session</button>';
    chat.appendChild(area);
    scrollBottom();
  }

  function appendScorecard(text) {
    const chat = document.getElementById('chatArea');
    const card = document.createElement('div'); card.className = 'scorecard';
    let html = '<h2>Session Scorecard</h2>', hit = false;

    for (const line of text.split('\n').filter(l => l.trim())) {
      const m = line.match(/^(Opening|Objection Handling|Rapport|Closing Attempt|Overall)[:\s]+(\d+)\/10\s*[â€”â€“-]+\s*(.+)$/i);
      if (!m) continue;
      const [, cat, score, feedback] = m; hit = true;
      if (cat.toLowerCase() === 'overall') {
        html += `<div class="overall-row"><span class="overall-label">Overall Score</span><span class="overall-badge">${score}/10</span></div>
                 <div style="text-align:center;font-size:13px;color:#555;margin-top:8px;">${esc(feedback)}</div>`;
      } else {
        html += `<div class="score-row"><span class="score-badge">${score}/10</span>
          <div class="score-body"><div class="score-cat">${esc(cat)}</div><div class="score-text">${esc(feedback)}</div></div></div>`;
      }
    }

    if (!hit) html += `<div class="scorecard-raw">${esc(text)}</div>`;
    card.innerHTML = html;
    chat.appendChild(card); scrollBottom();
  }

  // â”€â”€ Coach summary card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function appendCoachSummary(analysis) {
    const chat = document.getElementById('chatArea');
    const color = scoreColor(analysis.overall);
    const card = document.createElement('div');
    card.className = 'coach-summary';
    card.innerHTML = `
      <h3>Coach Analysis</h3>
      <div class="cs-score ${color}">${analysis.overall}%</div>
      <div class="cs-label">Overall Score</div>
      <div class="cs-summary">${esc(analysis.summary || '')}</div>
      <div class="cs-row">
        ${analysis.keyStrength   ? `<div class="cs-box"><div class="cs-box-title">ğŸ’ª Strength</div><div class="cs-box-text">${esc(analysis.keyStrength)}</div></div>` : ''}
        ${analysis.keyImprovement ? `<div class="cs-box"><div class="cs-box-title">ğŸ¯ Work On</div><div class="cs-box-text">${esc(analysis.keyImprovement)}</div></div>` : ''}
      </div>`;
    chat.appendChild(card);
    scrollBottom();
  }

  function scoreColor(n) {
    if (n >= 85) return 'gold';
    if (n >= 70) return 'green';
    if (n >= 50) return 'orange';
    return 'red';
  }

  // â”€â”€ Coach verbal feedback (TTS) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function speakCoachFeedback(analysis) {
    if (!window.speechSynthesis) return;
    speechSynthesis.cancel();

    const score = analysis.overall;
    const opener = score >= 85 ? 'Outstanding session!' : score >= 70 ? 'Good work today.' : score >= 50 ? 'Decent effort.' : 'Tough session, but every rep is a lesson.';
    const strength  = analysis.keyStrength    ? `Your biggest strength was: ${analysis.keyStrength}` : '';
    const improve   = analysis.keyImprovement ? `For next time, focus on: ${analysis.keyImprovement}` : '';
    const fullText  = [opener, strength, improve].filter(Boolean).join(' ');

    const utt = new SpeechSynthesisUtterance(fullText);
    utt.rate = 0.9; utt.pitch = 1.0;

    // Use a different (male) voice for coach if available, else fall back to same pool
    const coachVoice =
      voices.find(v => v.name === 'Google UK English Male') ||
      voices.find(v => v.name === 'Microsoft David - English (United States)') ||
      voices.find(v => v.lang === 'en-US' && /male/i.test(v.name)) ||
      voices.find(v => v.lang.startsWith('en'));
    if (coachVoice) utt.voice = coachVoice;

    speechSynthesis.speak(utt);
  }

  // â”€â”€ Save session to database â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function saveSession(analysis, duration) {
    try {
      await fetch('/save-session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          repName:     repName || 'Unknown',
          duration:    duration || 0,
          repMessages: repMessageCount,
          analysis,
        }),
      });
    } catch (err) {
      console.error('Failed to save session:', err);
    }
  }

  // â”€â”€ New session â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function newSession() {
    try { await fetch('/reset', { method: 'POST' }); } catch (_) {}
    if (window.speechSynthesis) speechSynthesis.cancel();
    document.getElementById('chatArea').innerHTML = `
      <div class="welcome">
        <strong>New Session Started!</strong>
        A fresh door is waiting. Tap <strong>Start Conversation</strong> and begin your pitch.
      </div>`;
    document.getElementById('endBtn').disabled = false;
    setConvState('idle');
  }
</script>
</body>
</html>
