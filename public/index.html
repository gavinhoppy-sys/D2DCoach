<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>D2D Roofing Sales Coach</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:          #161616;
      --bg2:         #1e1e1e;
      --surface:     rgba(255,255,255,0.04);
      --surface2:    rgba(255,255,255,0.07);
      --border:      rgba(255,255,255,0.08);
      --border2:     rgba(255,255,255,0.14);
      --text:        #f0f0f0;
      --text2:       rgba(255,255,255,0.55);
      --text3:       rgba(255,255,255,0.3);
      --purple:      #8b5cf6;
      --purple2:     #7c3aed;
      --purple-glow: rgba(139,92,246,0.35);
      --green:       #10b981;
      --green-glow:  rgba(16,185,129,0.3);
      --red:         #ef4444;
      --red-glow:    rgba(239,68,68,0.3);
      --amber:       #f59e0b;
    }

    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh; height: 100dvh;
      display: flex; flex-direction: column; overflow: hidden;
    }

    /* â”€â”€ Header â”€â”€ */
    .header {
      background: rgba(22,22,22,0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      padding: 12px 20px;
      display: flex; justify-content: space-between; align-items: center; gap: 10px;
      flex-shrink: 0; z-index: 10;
    }
    .header-brand { display: flex; align-items: center; gap: 10px; }
    .brand-dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: linear-gradient(135deg, var(--purple), #ec4899);
      box-shadow: 0 0 10px var(--purple-glow);
      flex-shrink: 0;
    }
    .header-title h1 { font-size: 15px; font-weight: 700; letter-spacing: -0.3px; }
    .header-title p  { font-size: 11px; color: var(--text2); margin-top: 1px; }
    .header-actions  { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }

    .icon-btn {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text2); width: 32px; height: 32px; border-radius: 8px;
      font-size: 14px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: background 0.15s, border-color 0.15s;
    }
    .icon-btn:hover { background: var(--surface2); border-color: var(--border2); color: var(--text); }

    .stop-conv-btn {
      background: rgba(239,68,68,0.12);
      border: 1px solid rgba(239,68,68,0.25);
      color: #fca5a5;
      padding: 5px 12px; border-radius: 8px; font-size: 12px; font-weight: 600;
      cursor: pointer; display: none; align-items: center; gap: 5px;
      font-family: inherit;
    }
    .stop-conv-btn.visible { display: flex; }
    .stop-conv-btn:hover { background: rgba(239,68,68,0.2); }

    .hub-link {
      color: var(--text2); text-decoration: none;
      font-size: 12px; font-weight: 500;
      padding: 5px 12px; border-radius: 8px;
      background: var(--surface);
      border: 1px solid var(--border);
      white-space: nowrap;
      transition: all 0.15s;
    }
    .hub-link:hover { background: var(--surface2); color: var(--text); border-color: var(--border2); }

    .end-btn {
      background: rgba(239,68,68,0.1);
      border: 1px solid rgba(239,68,68,0.3);
      color: #f87171;
      padding: 6px 14px; border-radius: 8px; font-size: 12px; font-weight: 600;
      cursor: pointer; white-space: nowrap; font-family: inherit;
      transition: all 0.15s;
    }
    .end-btn:hover:not(:disabled) { background: rgba(239,68,68,0.2); }
    .end-btn:disabled { opacity: 0.4; cursor: not-allowed; }

    /* â”€â”€ Chat area â”€â”€ */
    .chat-area {
      flex: 1; overflow-y: auto;
      padding: 20px 16px; display: flex; flex-direction: column; gap: 12px;
      scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.1) transparent;
    }
    .chat-area::-webkit-scrollbar { width: 4px; }
    .chat-area::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }

    /* Welcome */
    .welcome {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px; padding: 20px;
      text-align: center; color: var(--text2); font-size: 14px; line-height: 1.6;
    }
    .welcome strong {
      display: block; font-size: 17px; color: var(--text);
      font-weight: 700; margin-bottom: 8px; letter-spacing: -0.3px;
    }
    .welcome .key { color: var(--purple); font-weight: 600; }

    /* Rep bubbles */
    .rep-label { align-self: flex-end; font-size: 11px; color: var(--text3); padding-right: 4px; }
    .rep-wrap  { align-self: flex-end; max-width: 76%; display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
    .rep-bubble {
      background: linear-gradient(135deg, var(--purple2), var(--purple));
      color: white;
      padding: 10px 15px; border-radius: 16px 16px 4px 16px;
      font-size: 14px; line-height: 1.5; word-wrap: break-word;
      box-shadow: 0 4px 20px rgba(139,92,246,0.25);
    }
    .rep-metrics { font-size: 11px; color: var(--text3); padding-right: 4px; }

    /* Live preview */
    .live-preview {
      align-self: flex-end; max-width: 76%;
      background: rgba(139,92,246,0.08);
      border: 1px dashed rgba(139,92,246,0.35);
      color: var(--text2); padding: 10px 15px;
      border-radius: 16px 16px 4px 16px;
      font-size: 14px; font-style: italic; word-wrap: break-word; min-width: 48px;
    }

    /* Homeowner bubbles */
    .hw-group { display: flex; flex-direction: column; gap: 8px; }
    .hw-bubble {
      align-self: flex-start; max-width: 76%;
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 10px 15px; border-radius: 16px 16px 16px 4px;
      font-size: 14px; line-height: 1.5;
      word-wrap: break-word;
      backdrop-filter: blur(10px);
    }
    .coach-note {
      background: rgba(245,158,11,0.08);
      border: 1px solid rgba(245,158,11,0.2);
      border-left: 3px solid var(--amber);
      border-radius: 4px 12px 12px 4px;
      padding: 10px 14px;
      font-size: 13px; color: #fcd34d; line-height: 1.55; word-wrap: break-word;
    }
    .coach-tag {
      display: inline-block;
      background: rgba(245,158,11,0.2); color: var(--amber);
      font-size: 10px; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.8px; padding: 2px 8px; border-radius: 6px; margin-bottom: 6px;
    }

    /* Scorecard */
    .scorecard {
      background: var(--surface);
      border: 1px solid var(--border2);
      border-radius: 16px; padding: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    }
    .scorecard h2 {
      font-size: 14px; font-weight: 700; text-transform: uppercase;
      letter-spacing: 1px; color: var(--text2); margin-bottom: 16px; text-align: center;
    }
    .score-row { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 10px; }
    .score-badge {
      background: var(--surface2); border: 1px solid var(--border2);
      color: var(--purple); font-size: 12px; font-weight: 700;
      padding: 4px 10px; border-radius: 8px; white-space: nowrap; flex-shrink: 0;
    }
    .score-body .score-cat  { font-weight: 600; font-size: 13px; color: var(--text); }
    .score-body .score-text { font-size: 12px; color: var(--text2); margin-top: 2px; line-height: 1.4; }
    .overall-row {
      margin-top: 14px; padding-top: 14px; border-top: 1px solid var(--border);
      display: flex; align-items: center; justify-content: center; gap: 14px;
    }
    .overall-label { font-weight: 600; font-size: 14px; color: var(--text2); }
    .overall-badge {
      background: linear-gradient(135deg, var(--purple2), var(--purple));
      color: white; font-size: 20px; font-weight: 800;
      padding: 6px 20px; border-radius: 12px;
      box-shadow: 0 4px 16px var(--purple-glow);
    }
    .scorecard-raw { font-size: 13px; color: var(--text2); line-height: 1.6; white-space: pre-wrap; }

    /* Coach summary */
    .coach-summary {
      background: linear-gradient(135deg, rgba(124,58,237,0.15), rgba(139,92,246,0.08));
      border: 1px solid rgba(139,92,246,0.3);
      border-radius: 16px; padding: 20px;
      box-shadow: 0 8px 32px rgba(139,92,246,0.1);
    }
    .coach-summary h3 {
      font-size: 11px; text-transform: uppercase; letter-spacing: 1px;
      color: var(--purple); margin-bottom: 14px; font-weight: 600;
    }
    .cs-score { font-size: 52px; font-weight: 900; text-align: center; margin-bottom: 4px; letter-spacing: -2px; }
    .cs-score.red    { color: #ef4444; text-shadow: 0 0 20px rgba(239,68,68,0.4); }
    .cs-score.orange { color: #fb923c; text-shadow: 0 0 20px rgba(251,146,60,0.4); }
    .cs-score.green  { color: var(--green); text-shadow: 0 0 20px var(--green-glow); }
    .cs-score.gold   { color: #fbbf24; text-shadow: 0 0 20px rgba(251,191,36,0.4); }
    .cs-label { text-align: center; font-size: 11px; color: var(--text3); margin-bottom: 16px; text-transform: uppercase; letter-spacing: 0.8px; }
    .cs-summary { font-size: 13px; line-height: 1.65; color: var(--text2); margin-bottom: 16px; }
    .cs-row { display: flex; gap: 10px; }
    .cs-box {
      flex: 1; background: rgba(255,255,255,0.04); border: 1px solid var(--border);
      border-radius: 10px; padding: 12px;
    }
    .cs-box-title { font-size: 10px; text-transform: uppercase; letter-spacing: 0.6px; color: var(--text3); margin-bottom: 6px; }
    .cs-box-text  { font-size: 12px; line-height: 1.45; color: var(--text2); }

    /* Typing */
    .typing {
      display: flex; gap: 5px; align-items: center;
      padding: 12px 16px;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 16px 16px 16px 4px; align-self: flex-start;
    }
    .dot { width: 7px; height: 7px; background: var(--text3); border-radius: 50%; animation: bounce 1.2s infinite; }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce { 0%,60%,100%{transform:translateY(0)} 30%{transform:translateY(-5px)} }

    .error-msg {
      background: rgba(239,68,68,0.08); border: 1px solid rgba(239,68,68,0.2);
      border-radius: 10px; padding: 10px 14px;
      color: #fca5a5; font-size: 13px;
    }

    /* â”€â”€ Conversation bar â”€â”€ */
    .conv-bar {
      background: rgba(22,22,22,0.95);
      backdrop-filter: blur(20px);
      border-top: 1px solid var(--border);
      padding: 16px 20px;
      padding-bottom: max(16px, env(safe-area-inset-bottom));
      flex-shrink: 0;
      display: flex; flex-direction: column; gap: 12px;
    }

    /* Status */
    .status-bar {
      display: flex; align-items: center; justify-content: center;
      gap: 8px; min-height: 20px;
      font-size: 13px; font-weight: 500; color: var(--text3);
    }
    .status-bar.listening  { color: var(--red); }
    .status-bar.speaking   { color: var(--green); }
    .status-bar.processing { color: var(--purple); }

    /* Main button */
    .conv-main-btn {
      width: 100%; padding: 14px; border-radius: 12px; border: none;
      font-size: 15px; font-weight: 600; cursor: pointer; font-family: inherit;
      transition: all 0.15s; letter-spacing: -0.2px;
    }
    .conv-main-btn:active { transform: scale(0.98); }
    .conv-main-btn.idle {
      background: linear-gradient(135deg, var(--purple2), var(--purple));
      color: white;
      box-shadow: 0 4px 20px var(--purple-glow);
    }
    .conv-main-btn.idle:hover { box-shadow: 0 6px 28px rgba(139,92,246,0.5); }
    .conv-main-btn.send-now {
      background: rgba(239,68,68,0.1); color: var(--red);
      border: 1px solid rgba(239,68,68,0.25);
    }
    .conv-main-btn.send-now:hover { background: rgba(239,68,68,0.18); }
    .conv-main-btn.interrupt {
      background: rgba(16,185,129,0.1); color: var(--green);
      border: 1px solid rgba(16,185,129,0.25);
    }
    .conv-main-btn.interrupt:hover { background: rgba(16,185,129,0.18); }
    .conv-main-btn:disabled { background: var(--surface); color: var(--text3); cursor: not-allowed; transform: none; box-shadow: none; border: 1px solid var(--border); }

    /* Wave bars */
    .wave-bars { display: flex; align-items: center; gap: 3px; height: 16px; }
    .wave-bar  { width: 2.5px; border-radius: 2px; animation: wavebar 0.9s ease-in-out infinite; }
    .wave-bar:nth-child(1) { animation-delay: 0.0s;  height: 6px; }
    .wave-bar:nth-child(2) { animation-delay: 0.15s; height: 12px; }
    .wave-bar:nth-child(3) { animation-delay: 0.3s;  height: 16px; }
    .wave-bar:nth-child(4) { animation-delay: 0.15s; height: 12px; }
    .wave-bar:nth-child(5) { animation-delay: 0.0s;  height: 6px; }
    @keyframes wavebar { 0%,100%{transform:scaleY(0.4)} 50%{transform:scaleY(1)} }
    .wave-bar.red   { background: var(--red); }
    .wave-bar.green { background: var(--green); }

    /* Spinner */
    .spinner {
      width: 16px; height: 16px; border-radius: 50%;
      border: 2px solid rgba(139,92,246,0.2); border-top-color: var(--purple);
      animation: spin 0.7s linear infinite; flex-shrink: 0;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Text fallback */
    .text-fallback { display: none; gap: 8px; align-items: flex-end; }
    .text-fallback textarea {
      flex: 1; background: var(--surface); border: 1px solid var(--border);
      color: var(--text); border-radius: 10px;
      padding: 10px 14px; font-size: 14px; line-height: 1.4;
      resize: none; outline: none; font-family: inherit;
    }
    .text-fallback textarea:focus { border-color: var(--purple); }
    .text-fallback textarea::placeholder { color: var(--text3); }
    .send-text-btn {
      background: var(--purple); color: white; border: none;
      padding: 10px 18px; border-radius: 10px; font-size: 14px;
      font-weight: 600; cursor: pointer; font-family: inherit;
    }

    /* New session */
    .new-session-area { text-align: center; padding: 6px 0 2px; }
    .new-btn {
      background: none; border: 1px solid var(--border2); color: var(--text2);
      padding: 8px 22px; border-radius: 10px; font-size: 13px; font-weight: 600;
      cursor: pointer; font-family: inherit;
      transition: all 0.15s;
    }
    .new-btn:hover { background: var(--surface2); color: var(--text); border-color: var(--purple); }

    /* â”€â”€ Name modal â”€â”€ */
    .modal-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.75);
      backdrop-filter: blur(8px);
      display: flex; align-items: center; justify-content: center;
      z-index: 100; padding: 20px;
    }
    .modal-overlay.hidden { display: none; }
    .modal-box {
      background: #1e1e1e;
      border: 1px solid var(--border2);
      border-radius: 20px; padding: 36px 32px;
      max-width: 380px; width: 100%;
      box-shadow: 0 32px 80px rgba(0,0,0,0.6), 0 0 0 1px rgba(255,255,255,0.05);
      text-align: center;
    }
    .modal-icon {
      width: 52px; height: 52px; border-radius: 14px; margin: 0 auto 20px;
      background: linear-gradient(135deg, var(--purple2), var(--purple));
      display: flex; align-items: center; justify-content: center;
      font-size: 24px;
      box-shadow: 0 8px 24px var(--purple-glow);
    }
    .modal-box h2 { font-size: 20px; font-weight: 700; color: var(--text); margin-bottom: 8px; letter-spacing: -0.4px; }
    .modal-box p  { font-size: 13px; color: var(--text2); margin-bottom: 24px; line-height: 1.6; }
    .modal-input {
      width: 100%; background: var(--surface); border: 1px solid var(--border2);
      color: var(--text); border-radius: 10px;
      padding: 12px 16px; font-size: 15px; outline: none; font-family: inherit;
      margin-bottom: 12px;
    }
    .modal-input:focus { border-color: var(--purple); box-shadow: 0 0 0 3px rgba(139,92,246,0.15); }
    .modal-input::placeholder { color: var(--text3); }
    .modal-submit {
      width: 100%;
      background: linear-gradient(135deg, var(--purple2), var(--purple));
      color: white; border: none;
      padding: 13px; border-radius: 10px; font-size: 15px; font-weight: 700;
      cursor: pointer; font-family: inherit;
      box-shadow: 0 4px 16px var(--purple-glow);
      transition: box-shadow 0.15s;
    }
    .modal-submit:hover { box-shadow: 0 6px 24px rgba(139,92,246,0.5); }
  </style>
</head>
<body>

<!-- Rep name modal -->
<div class="modal-overlay" id="nameModal">
  <div class="modal-box">
    <div class="modal-icon">ğŸ¯</div>
    <h2>Welcome, Rep</h2>
    <p>Enter your name so we can track your progress over time.</p>
    <input class="modal-input" id="nameInput" type="text" placeholder="Your first name" maxlength="40"
      onkeydown="if(event.key==='Enter') submitName()">
    <button class="modal-submit" onclick="submitName()">Start Training</button>
  </div>
</div>

<div class="header">
  <div class="header-brand">
    <div class="brand-dot"></div>
    <div class="header-title">
      <h1>D2D Coach</h1>
      <p id="repNameDisplay">Roofing Sales Training</p>
    </div>
  </div>
  <div class="header-actions">
    <a href="/hub.html" class="hub-link">ğŸ“‹ Hub</a>
    <button class="icon-btn" id="voiceBtn" onclick="toggleTTS()" title="Mute homeowner voice">ğŸ”Š</button>
    <button class="stop-conv-btn" id="stopConvBtn" onclick="stopConversation()">â–  Stop</button>
    <button class="end-btn" id="endBtn" onclick="endSession()">End Session</button>
  </div>
</div>

<div class="chat-area" id="chatArea">
  <div class="welcome">
    <strong>Ready to practice?</strong>
    Tap <span class="key">Start Conversation</span> â€” the mic opens, you pitch the homeowner, and Claude responds in real time. Your pace, energy, and delivery are graded after every turn.
  </div>
</div>

<div class="conv-bar">
  <div class="status-bar" id="statusBar"></div>
  <button class="conv-main-btn idle" id="mainBtn" onclick="handleMainBtn()">
    â–¶ Start Conversation
  </button>
  <div class="text-fallback" id="textFallback">
    <textarea id="msgInput" placeholder="Type your pitchâ€¦" rows="2"
      onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendTextMessage();}"></textarea>
    <button class="send-text-btn" onclick="sendTextMessage()">Send</button>
  </div>
</div>

<script>
  // â”€â”€ Rep name â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let repName = localStorage.getItem('d2d_rep_name') || '';

  function submitName() {
    const val = document.getElementById('nameInput').value.trim();
    if (!val) return;
    repName = val;
    localStorage.setItem('d2d_rep_name', repName);
    document.getElementById('nameModal').classList.add('hidden');
    document.getElementById('repNameDisplay').textContent = 'Hey, ' + repName;
  }

  // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let convState  = 'idle';
  let ttsEnabled = true;
  let sessionStartTime = null;
  let repMessageCount  = 0;
  let sendDebounce     = null;
  let currentTranscript = '';

  // Audio analysis
  let audioCtx = null, analyser = null, micStream = null, analysisInterval = null;
  let energySamples = [], freqSamples = [], recordStart = 0;

  const hasSpeech = !!(window.SpeechRecognition || window.webkitSpeechRecognition);
  let recognition = null;

  let voices = [];
  if (window.speechSynthesis) {
    speechSynthesis.onvoiceschanged = () => { voices = speechSynthesis.getVoices(); };
    setTimeout(() => { voices = speechSynthesis.getVoices(); }, 300);
  }

  // â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  (function boot() {
    if (!repName) {
      document.getElementById('nameModal').classList.remove('hidden');
      setTimeout(() => document.getElementById('nameInput').focus(), 100);
    } else {
      document.getElementById('nameModal').classList.add('hidden');
      document.getElementById('repNameDisplay').textContent = 'Hey, ' + repName;
    }
    if (hasSpeech) {
      setupRecognition();
      document.getElementById('textFallback').style.display = 'none';
    } else {
      document.getElementById('textFallback').style.display = 'flex';
      document.getElementById('mainBtn').style.display = 'none';
      document.getElementById('statusBar').style.display = 'none';
      document.getElementById('voiceBtn').style.display = 'none';
    }
  })();

  // â”€â”€ Speech recognition â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setupRecognition() {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    recognition = new SR();
    recognition.continuous = true; recognition.interimResults = true; recognition.lang = 'en-US';

    recognition.onresult = (e) => {
      let final = '', interim = '';
      for (let i = 0; i < e.results.length; i++) {
        e.results[i].isFinal ? (final += e.results[i][0].transcript + ' ') : (interim += e.results[i][0].transcript);
      }
      currentTranscript = (final + interim).trim();
      updateLivePreview(currentTranscript);
      if (e.results[e.results.length - 1].isFinal) {
        const wordCount = final.trim().split(/\s+/).filter(Boolean).length;
        if (wordCount >= 2) {
          clearTimeout(sendDebounce);
          sendDebounce = setTimeout(() => { if (convState === 'listening') triggerAutoSend(); }, 4000);
        }
      }
    };

    recognition.onerror = (e) => { if (e.error !== 'no-speech' && e.error !== 'aborted') console.error('SR:', e.error); };
    recognition.onend   = () => { if (convState === 'listening') { try { recognition.start(); } catch (_) {} } };
  }

  // â”€â”€ Main button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function handleMainBtn() {
    switch (convState) {
      case 'idle':      startConversation(); break;
      case 'listening': triggerAutoSend();   break;
      case 'speaking':  interruptHomeowner(); break;
    }
  }

  // â”€â”€ Lifecycle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function startConversation() {
    if (convState !== 'idle') return;
    sessionStartTime = Date.now(); repMessageCount = 0;
    setConvState('listening'); await openMic();
  }

  function stopConversation() {
    clearTimeout(sendDebounce);
    if (window.speechSynthesis) speechSynthesis.cancel();
    closeMic(); clearLivePreview(); currentTranscript = '';
    setConvState('idle');
  }

  function interruptHomeowner() {
    if (window.speechSynthesis) speechSynthesis.cancel();
    setConvState('listening'); openMic();
  }

  // â”€â”€ Mic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function openMic() {
    try {
      micStream = await navigator.mediaDevices.getUserMedia({
        audio: { echoCancellation: true, noiseSuppression: true, autoGainControl: true }, video: false,
      });
    } catch (_) {
      alert('Microphone access denied.');
      setConvState('idle'); return;
    }
    audioCtx = new AudioContext(); analyser = audioCtx.createAnalyser(); analyser.fftSize = 2048;
    audioCtx.createMediaStreamSource(micStream).connect(analyser);
    energySamples = []; freqSamples = []; recordStart = Date.now(); currentTranscript = '';
    try { recognition.start(); } catch (_) {}
    analysisInterval = setInterval(sampleAudio, 150);
  }

  function closeMic() {
    clearInterval(analysisInterval);
    try { recognition.stop(); } catch (_) {}
    if (micStream) { micStream.getTracks().forEach(t => t.stop()); micStream = null; }
    if (audioCtx)  { audioCtx.close().catch(() => {}); audioCtx = null; }
    analyser = null;
  }

  // â”€â”€ Audio sampling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function sampleAudio() {
    if (!analyser) return;
    const td = new Float32Array(analyser.fftSize);
    analyser.getFloatTimeDomainData(td);
    const rms = Math.sqrt(td.reduce((s, v) => s + v * v, 0) / td.length);
    if (rms > 0.003) energySamples.push(rms);
    const fd = new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(fd);
    const binHz = (audioCtx ? audioCtx.sampleRate : 44100) / analyser.fftSize;
    const minBin = Math.floor(80 / binHz), maxBin = Math.min(Math.floor(1000 / binHz), fd.length - 1);
    let maxVal = 0, maxIdx = 0;
    for (let i = minBin; i <= maxBin; i++) { if (fd[i] > maxVal) { maxVal = fd[i]; maxIdx = i; } }
    if (maxVal > 20) freqSamples.push(maxIdx * binHz);
  }

  // â”€â”€ Auto-send â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function triggerAutoSend() {
    clearTimeout(sendDebounce);
    const text = currentTranscript.trim();
    if (!text || convState !== 'listening') return;
    const duration = (Date.now() - recordStart) / 1000;
    const metrics  = buildMetrics(text, duration);
    closeMic(); clearLivePreview(); currentTranscript = '';
    setConvState('processing'); sendToServer(text, metrics);
  }

  async function sendToServer(text, metrics) {
    const fullMsg = metrics ? `${text}\n\n[Voice: ${metrics}]` : text;
    repMessageCount++;
    appendRepMsg(text, metrics); showTyping();
    try {
      const res  = await fetch('/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: fullMsg }) });
      const data = await res.json();
      removeTyping();
      if (data.error) { showError(data.error); setConvState('idle'); }
      else { appendHomeownerResponse(data.response); setConvState('speaking'); speakHomeowner(data.response); }
    } catch (_) { removeTyping(); showError('Could not reach the server.'); setConvState('idle'); }
  }

  // â”€â”€ Metrics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function buildMetrics(transcript, duration) {
    const words = transcript.split(/\s+/).filter(w => w.length > 0);
    const wpm   = duration > 1 ? Math.round((words.length / duration) * 60) : 0;
    let energy  = '';
    if (energySamples.length > 0) {
      const avg = energySamples.reduce((a, b) => a + b, 0) / energySamples.length;
      energy = avg < 0.025 ? 'Soft energy' : avg < 0.06 ? 'Moderate energy' : 'Strong energy';
    }
    let pitch = '';
    if (freqSamples.length > 5) {
      const mean = freqSamples.reduce((a, b) => a + b, 0) / freqSamples.length;
      const sd   = Math.sqrt(freqSamples.reduce((s, v) => s + (v - mean) ** 2, 0) / freqSamples.length);
      pitch = sd < 35 ? 'Monotone' : sd < 85 ? 'Natural variation' : 'Dynamic pitch';
    }
    const fillers = (transcript.match(/\b(um+|uh+|like|you know|basically|literally|right\?|so+)\b/gi) || []).length;
    const parts = [];
    if (wpm > 0)     parts.push(`${wpm} WPM`);
    if (energy)      parts.push(energy);
    if (pitch)       parts.push(pitch);
    if (fillers > 0) parts.push(`${fillers} filler word${fillers !== 1 ? 's' : ''}`);
    if (duration > 0) parts.push(`${Math.round(duration)}s`);
    return parts.join(' Â· ');
  }

  // â”€â”€ TTS homeowner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function speakHomeowner(rawText) {
    const coachIdx = rawText.indexOf('COACH:');
    const text = (coachIdx !== -1 ? rawText.slice(0, coachIdx) : rawText).trim();
    const resume = () => {
      if (convState === 'speaking') { setTimeout(() => { setConvState('listening'); openMic(); }, 500); }
    };
    if (!text || !ttsEnabled || !window.speechSynthesis) { resume(); return; }
    speechSynthesis.cancel();
    const utt = new SpeechSynthesisUtterance(text);
    utt.rate = 0.92; utt.pitch = 1.0;
    const preferred =
      voices.find(v => v.name === 'Google UK English Female') ||
      voices.find(v => v.name === 'Google US English')        ||
      voices.find(v => v.name === 'Microsoft Zira - English (United States)') ||
      voices.find(v => v.lang.startsWith('en') && /natural|neural|online/i.test(v.name)) ||
      voices.find(v => v.lang === 'en-US') ||
      voices.find(v => v.lang.startsWith('en'));
    if (preferred) utt.voice = preferred;
    utt.onend = resume; utt.onerror = resume;
    speechSynthesis.speak(utt);
  }

  function toggleTTS() {
    ttsEnabled = !ttsEnabled;
    document.getElementById('voiceBtn').textContent = ttsEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
    if (!ttsEnabled && window.speechSynthesis) {
      speechSynthesis.cancel();
      if (convState === 'speaking') { setConvState('listening'); openMic(); }
    }
  }

  // â”€â”€ State UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function setConvState(state) {
    convState = state;
    const statusEl = document.getElementById('statusBar');
    const btn      = document.getElementById('mainBtn');
    const stopBtn  = document.getElementById('stopConvBtn');
    const endBtn   = document.getElementById('endBtn');
    const waveBars = (color) => `<div class="wave-bars">${Array(5).fill(`<div class="wave-bar ${color}"></div>`).join('')}</div>`;
    const inConv = state !== 'idle' && state !== 'ended';
    stopBtn.classList.toggle('visible', inConv);
    endBtn.disabled = state === 'processing';
    switch (state) {
      case 'idle':
        statusEl.innerHTML = ''; statusEl.className = 'status-bar';
        btn.textContent = 'â–¶ Start Conversation'; btn.className = 'conv-main-btn idle'; btn.disabled = false;
        break;
      case 'listening':
        statusEl.innerHTML = `${waveBars('red')} <span>Listeningâ€¦</span>`; statusEl.className = 'status-bar listening';
        btn.textContent = 'â Send Now'; btn.className = 'conv-main-btn send-now'; btn.disabled = false;
        break;
      case 'processing':
        statusEl.innerHTML = '<div class="spinner"></div><span>Processingâ€¦</span>'; statusEl.className = 'status-bar processing';
        btn.textContent = 'Processingâ€¦'; btn.className = 'conv-main-btn'; btn.disabled = true;
        break;
      case 'speaking':
        statusEl.innerHTML = `${waveBars('green')} <span>Homeowner speakingâ€¦</span>`; statusEl.className = 'status-bar speaking';
        btn.textContent = 'â­ Interrupt'; btn.className = 'conv-main-btn interrupt'; btn.disabled = false;
        break;
      case 'ended':
        statusEl.innerHTML = ''; statusEl.className = 'status-bar';
        btn.textContent = 'Session Ended'; btn.className = 'conv-main-btn'; btn.disabled = true;
        break;
    }
  }

  // â”€â”€ Live preview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function updateLivePreview(text) {
    let el = document.getElementById('livePreview');
    if (!el) { el = document.createElement('div'); el.id = 'livePreview'; el.className = 'live-preview'; document.getElementById('chatArea').appendChild(el); }
    el.textContent = text || 'â€¦'; scrollBottom();
  }
  function clearLivePreview() { const el = document.getElementById('livePreview'); if (el) el.remove(); }

  // â”€â”€ Text fallback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function sendTextMessage() {
    const input = document.getElementById('msgInput');
    const text  = (input.value || '').trim();
    if (!text) return;
    input.value = ''; appendRepMsg(text, ''); showTyping();
    try {
      const res  = await fetch('/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: text }) });
      const data = await res.json();
      removeTyping();
      if (data.error) showError(data.error);
      else appendHomeownerResponse(data.response);
    } catch (_) { removeTyping(); showError('Could not reach the server.'); }
  }

  // â”€â”€ DOM helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function esc(t) { return (t || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
  function scrollBottom() { const c = document.getElementById('chatArea'); c.scrollTop = c.scrollHeight; }

  function appendRepMsg(text, metrics) {
    const chat = document.getElementById('chatArea');
    const lbl = document.createElement('div'); lbl.className = 'rep-label'; lbl.textContent = 'You';
    const wrap = document.createElement('div'); wrap.className = 'rep-wrap';
    const bub  = document.createElement('div'); bub.className = 'rep-bubble'; bub.textContent = text;
    wrap.appendChild(bub);
    if (metrics) { const m = document.createElement('div'); m.className = 'rep-metrics'; m.textContent = 'ğŸ¤ ' + metrics; wrap.appendChild(m); }
    chat.appendChild(lbl); chat.appendChild(wrap); scrollBottom();
  }

  function appendHomeownerResponse(raw) {
    const chat     = document.getElementById('chatArea');
    const coachIdx = raw.indexOf('COACH:');
    const hwText   = coachIdx !== -1 ? raw.slice(0, coachIdx).trim() : raw.trim();
    const coachTxt = coachIdx !== -1 ? raw.slice(coachIdx + 6).trim() : null;
    const group = document.createElement('div'); group.className = 'hw-group';
    const bub   = document.createElement('div'); bub.className = 'hw-bubble'; bub.textContent = hwText;
    group.appendChild(bub);
    if (coachTxt) {
      const note = document.createElement('div'); note.className = 'coach-note';
      note.innerHTML = `<span class="coach-tag">Coach</span><div>${esc(coachTxt)}</div>`;
      group.appendChild(note);
    }
    chat.appendChild(group); scrollBottom();
  }

  function showTyping() {
    const chat = document.getElementById('chatArea');
    const el = document.createElement('div'); el.className = 'typing'; el.id = 'typing';
    el.innerHTML = '<div class="dot"></div><div class="dot"></div><div class="dot"></div>';
    chat.appendChild(el); scrollBottom();
  }
  function removeTyping() { const el = document.getElementById('typing'); if (el) el.remove(); }
  function showError(msg) {
    const chat = document.getElementById('chatArea');
    const el = document.createElement('div'); el.className = 'error-msg'; el.textContent = 'âš  ' + msg;
    chat.appendChild(el); scrollBottom();
  }

  // â”€â”€ End session â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function endSession() {
    if (convState === 'ended') return;
    clearTimeout(sendDebounce);
    if (window.speechSynthesis) speechSynthesis.cancel();
    closeMic(); clearLivePreview();
    setConvState('ended');
    document.getElementById('endBtn').disabled = true;
    showTyping();
    try {
      const sessionDuration = sessionStartTime ? Math.round((Date.now() - sessionStartTime) / 1000) : 0;
      const [scorecardRes, analyzeRes] = await Promise.all([
        fetch('/scorecard', { method: 'POST', headers: { 'Content-Type': 'application/json' } }),
        fetch('/analyze',   { method: 'POST', headers: { 'Content-Type': 'application/json' } }),
      ]);
      const [scorecardData, analyzeData] = await Promise.all([scorecardRes.json(), analyzeRes.json()]);
      removeTyping();
      if (scorecardData.scorecard) appendScorecard(scorecardData.scorecard);
      else showError(scorecardData.error || 'Failed to generate scorecard.');
      if (analyzeData.analysis) {
        appendCoachSummary(analyzeData.analysis);
        speakCoachFeedback(analyzeData.analysis);
        saveSession(analyzeData.analysis, sessionDuration);
      }
    } catch (_) { removeTyping(); showError('Could not reach the server.'); }
    const chat = document.getElementById('chatArea');
    const area = document.createElement('div'); area.className = 'new-session-area';
    area.innerHTML = '<button class="new-btn" onclick="newSession()">â†© Start New Session</button>';
    chat.appendChild(area); scrollBottom();
  }

  function appendScorecard(text) {
    const chat = document.getElementById('chatArea');
    const card = document.createElement('div'); card.className = 'scorecard';
    let html = '<h2>Session Scorecard</h2>', hit = false;
    for (const line of text.split('\n').filter(l => l.trim())) {
      const m = line.match(/^(Opening|Objection Handling|Rapport|Closing Attempt|Overall)[:\s]+(\d+)\/10\s*[â€”â€“-]+\s*(.+)$/i);
      if (!m) continue;
      const [, cat, score, feedback] = m; hit = true;
      if (cat.toLowerCase() === 'overall') {
        html += `<div class="overall-row"><span class="overall-label">Overall Score</span><span class="overall-badge">${score}/10</span></div>
                 <div style="text-align:center;font-size:12px;color:var(--text2);margin-top:8px;">${esc(feedback)}</div>`;
      } else {
        html += `<div class="score-row"><span class="score-badge">${score}/10</span>
          <div class="score-body"><div class="score-cat">${esc(cat)}</div><div class="score-text">${esc(feedback)}</div></div></div>`;
      }
    }
    if (!hit) html += `<div class="scorecard-raw">${esc(text)}</div>`;
    card.innerHTML = html; chat.appendChild(card); scrollBottom();
  }

  // â”€â”€ Coach summary card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function appendCoachSummary(analysis) {
    const chat = document.getElementById('chatArea');
    const color = scoreColor(analysis.overall);
    const card = document.createElement('div'); card.className = 'coach-summary';
    card.innerHTML = `
      <h3>Coach Analysis</h3>
      <div class="cs-score ${color}">${analysis.overall}%</div>
      <div class="cs-label">Overall Score</div>
      <div class="cs-summary">${esc(analysis.summary || '')}</div>
      <div class="cs-row">
        ${analysis.keyStrength    ? `<div class="cs-box"><div class="cs-box-title">ğŸ’ª Strength</div><div class="cs-box-text">${esc(analysis.keyStrength)}</div></div>` : ''}
        ${analysis.keyImprovement ? `<div class="cs-box"><div class="cs-box-title">ğŸ¯ Work On</div><div class="cs-box-text">${esc(analysis.keyImprovement)}</div></div>` : ''}
      </div>`;
    chat.appendChild(card); scrollBottom();
  }

  function scoreColor(n) {
    if (n >= 85) return 'gold';
    if (n >= 70) return 'green';
    if (n >= 50) return 'orange';
    return 'red';
  }

  // â”€â”€ Coach TTS feedback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function speakCoachFeedback(analysis) {
    if (!window.speechSynthesis) return;
    speechSynthesis.cancel();
    const score  = analysis.overall;
    const opener = score >= 85 ? 'Outstanding session!' : score >= 70 ? 'Good work today.' : score >= 50 ? 'Decent effort.' : 'Tough session, but every rep is a lesson.';
    const parts  = [opener];
    if (analysis.keyStrength)    parts.push('Your biggest strength was: ' + analysis.keyStrength);
    if (analysis.keyImprovement) parts.push('For next time, focus on: ' + analysis.keyImprovement);
    const utt = new SpeechSynthesisUtterance(parts.join(' '));
    utt.rate = 0.9; utt.pitch = 1.0;
    const coachVoice =
      voices.find(v => v.name === 'Google UK English Male') ||
      voices.find(v => v.name === 'Microsoft David - English (United States)') ||
      voices.find(v => v.lang === 'en-US' && /male/i.test(v.name)) ||
      voices.find(v => v.lang.startsWith('en'));
    if (coachVoice) utt.voice = coachVoice;
    speechSynthesis.speak(utt);
  }

  // â”€â”€ Save session to DB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function saveSession(analysis, duration) {
    try {
      await fetch('/save-session', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ repName: repName || 'Unknown', duration: duration || 0, repMessages: repMessageCount, analysis }),
      });
    } catch (err) { console.error('Failed to save session:', err); }
  }

  // â”€â”€ New session â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function newSession() {
    try { await fetch('/reset', { method: 'POST' }); } catch (_) {}
    if (window.speechSynthesis) speechSynthesis.cancel();
    document.getElementById('chatArea').innerHTML = `
      <div class="welcome">
        <strong>New session started</strong>
        A fresh door is waiting. Tap <span class="key">Start Conversation</span> and begin your pitch.
      </div>`;
    document.getElementById('endBtn').disabled = false;
    setConvState('idle');
  }
</script>
</body>
</html>
