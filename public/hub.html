<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>D2D Coach ‚Äî Hub</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:        #161616;
      --bg2:       #1e1e1e;
      --surface:   rgba(255,255,255,0.04);
      --surface2:  rgba(255,255,255,0.07);
      --border:    rgba(255,255,255,0.08);
      --border2:   rgba(255,255,255,0.14);
      --text:      #f0f0f0;
      --text2:     rgba(255,255,255,0.55);
      --text3:     rgba(255,255,255,0.3);
      --purple:    #8b5cf6;
      --purple2:   #7c3aed;
      --purple-glow: rgba(139,92,246,0.3);
      --green:     #10b981;
      --red:       #ef4444;
      --amber:     #f59e0b;
    }

    body {
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--bg); color: var(--text); min-height: 100vh;
    }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    .header {
      background: rgba(22,22,22,0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      padding: 14px 24px;
      display: flex; justify-content: space-between; align-items: center;
      position: sticky; top: 0; z-index: 10;
    }
    .header-brand { display: flex; align-items: center; gap: 10px; }
    .brand-dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: linear-gradient(135deg, var(--purple), #ec4899);
      box-shadow: 0 0 10px var(--purple-glow);
    }
    .header-title h1 { font-size: 15px; font-weight: 700; letter-spacing: -0.3px; }
    .header-title p  { font-size: 11px; color: var(--text2); margin-top: 1px; }
    .header-right { display: flex; align-items: center; gap: 10px; }
    .rep-badge {
      font-size: 12px; color: var(--text2);
      background: var(--surface); border: 1px solid var(--border);
      padding: 4px 12px; border-radius: 8px;
    }
    .practice-btn {
      background: linear-gradient(135deg, var(--purple2), var(--purple));
      color: white; text-decoration: none;
      padding: 7px 16px; border-radius: 8px; font-size: 13px; font-weight: 600;
      box-shadow: 0 4px 14px var(--purple-glow);
      transition: box-shadow 0.15s;
    }
    .practice-btn:hover { box-shadow: 0 6px 20px rgba(139,92,246,0.5); }

    /* ‚îÄ‚îÄ Main ‚îÄ‚îÄ */
    .main { max-width: 720px; margin: 0 auto; padding: 28px 20px 60px; }

    /* ‚îÄ‚îÄ Name prompt ‚îÄ‚îÄ */
    .name-prompt {
      background: var(--bg2); border: 1px solid var(--border2);
      border-radius: 20px; padding: 40px 32px; text-align: center;
      box-shadow: 0 16px 48px rgba(0,0,0,0.4);
    }
    .name-prompt-icon {
      width: 52px; height: 52px; border-radius: 14px; margin: 0 auto 20px;
      background: linear-gradient(135deg, var(--purple2), var(--purple));
      display: flex; align-items: center; justify-content: center; font-size: 24px;
      box-shadow: 0 8px 24px var(--purple-glow);
    }
    .name-prompt h2 { font-size: 20px; font-weight: 700; margin-bottom: 8px; letter-spacing: -0.4px; }
    .name-prompt p  { font-size: 13px; color: var(--text2); margin-bottom: 24px; line-height: 1.6; }
    .name-row { display: flex; gap: 10px; max-width: 340px; margin: 0 auto; }
    .name-input {
      flex: 1; background: var(--surface); border: 1px solid var(--border2);
      color: var(--text); border-radius: 10px;
      padding: 11px 14px; font-size: 15px; outline: none; font-family: inherit;
    }
    .name-input:focus { border-color: var(--purple); box-shadow: 0 0 0 3px rgba(139,92,246,0.15); }
    .name-input::placeholder { color: var(--text3); }
    .name-submit {
      background: linear-gradient(135deg, var(--purple2), var(--purple));
      color: white; border: none;
      padding: 11px 20px; border-radius: 10px; font-size: 14px;
      font-weight: 600; cursor: pointer; font-family: inherit;
      box-shadow: 0 4px 14px var(--purple-glow);
    }
    .name-submit:hover { box-shadow: 0 6px 20px rgba(139,92,246,0.5); }

    /* ‚îÄ‚îÄ Section title ‚îÄ‚îÄ */
    .section-title {
      font-size: 11px; font-weight: 600; text-transform: uppercase;
      letter-spacing: 1px; color: var(--text3); margin-bottom: 14px;
    }

    /* ‚îÄ‚îÄ Stats row ‚îÄ‚îÄ */
    .stats-row { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .stat-box {
      flex: 1; min-width: 90px;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 14px; padding: 16px 14px; text-align: center;
      transition: border-color 0.15s, background 0.15s;
    }
    .stat-box:hover { background: var(--surface2); border-color: var(--border2); }
    .stat-num { font-size: 26px; font-weight: 800; color: var(--text); letter-spacing: -1px; }
    .stat-num.green  { color: var(--green); }
    .stat-num.orange { color: #fb923c; }
    .stat-num.red    { color: var(--red); }
    .stat-num.gold   { color: #fbbf24; }
    .stat-label { font-size: 10px; color: var(--text3); margin-top: 4px; text-transform: uppercase; letter-spacing: 0.5px; }

    /* ‚îÄ‚îÄ Progress card ‚îÄ‚îÄ */
    .progress-section {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 16px; padding: 20px; margin-bottom: 20px;
    }

    /* Trend chart */
    svg.trend { width: 100%; height: 80px; overflow: visible; }
    .chart-label {
      display: flex; justify-content: space-between;
      font-size: 10px; color: var(--text3); margin-top: 6px;
      text-transform: uppercase; letter-spacing: 0.4px;
    }

    .no-data { text-align: center; padding: 32px 20px; color: var(--text3); font-size: 14px; }
    .no-data strong { display: block; font-size: 17px; color: var(--text2); margin-bottom: 8px; font-weight: 600; }

    /* ‚îÄ‚îÄ Session cards ‚îÄ‚îÄ */
    .sessions-section { display: flex; flex-direction: column; gap: 10px; }

    .session-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 14px; overflow: hidden; cursor: pointer;
      transition: border-color 0.15s, background 0.15s;
    }
    .session-card:hover { background: var(--surface2); border-color: var(--border2); }

    .card-header { display: flex; align-items: center; gap: 14px; padding: 16px; }

    .score-circle {
      width: 52px; height: 52px; border-radius: 12px;
      display: flex; align-items: center; justify-content: center;
      font-size: 14px; font-weight: 800; flex-shrink: 0; color: white;
      letter-spacing: -0.5px;
    }
    .score-circle.red    { background: rgba(239,68,68,0.2);   border: 1px solid rgba(239,68,68,0.4);   color: #f87171; }
    .score-circle.orange { background: rgba(251,146,60,0.2);  border: 1px solid rgba(251,146,60,0.4);  color: #fb923c; }
    .score-circle.green  { background: rgba(16,185,129,0.2);  border: 1px solid rgba(16,185,129,0.4);  color: #34d399; }
    .score-circle.gold   { background: rgba(251,191,36,0.2);  border: 1px solid rgba(251,191,36,0.4);  color: #fbbf24; }

    .card-meta { flex: 1; min-width: 0; }
    .card-date  { font-size: 12px; color: var(--text3); }
    .card-turns { font-size: 11px; color: var(--text3); margin-top: 2px; }
    .card-summary {
      font-size: 13px; color: var(--text2); margin-top: 5px;
      line-height: 1.4; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    .expand-icon { font-size: 16px; color: var(--text3); flex-shrink: 0; transition: transform 0.2s; }
    .session-card.open .expand-icon { transform: rotate(180deg); }

    .card-body { display: none; padding: 0 16px 16px; border-top: 1px solid var(--border); }
    .session-card.open .card-body { display: block; }

    .key-points { display: flex; gap: 10px; margin: 14px 0; flex-wrap: wrap; }
    .key-point {
      flex: 1; min-width: 140px; border-radius: 10px; padding: 10px 12px;
      font-size: 12px; line-height: 1.5;
    }
    .key-point.strength {
      background: rgba(16,185,129,0.08); color: #6ee7b7;
      border: 1px solid rgba(16,185,129,0.2);
    }
    .key-point.improve  {
      background: rgba(245,158,11,0.08); color: #fcd34d;
      border: 1px solid rgba(245,158,11,0.2);
    }
    .key-point strong {
      display: block; font-size: 10px; text-transform: uppercase;
      letter-spacing: 0.6px; margin-bottom: 4px; opacity: 0.6;
    }

    .breakdown-grid { display: flex; flex-direction: column; gap: 8px; margin-top: 14px; }
    .breakdown-row { display: flex; align-items: center; gap: 10px; }
    .breakdown-label { font-size: 11px; font-weight: 600; color: var(--text2); width: 120px; flex-shrink: 0; }
    .bar-track { flex: 1; background: rgba(255,255,255,0.06); border-radius: 4px; height: 6px; overflow: hidden; }
    .bar-fill  { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
    .bar-fill.red    { background: rgba(239,68,68,0.7); }
    .bar-fill.orange { background: rgba(251,146,60,0.7); }
    .bar-fill.green  { background: rgba(16,185,129,0.7); }
    .bar-fill.gold   { background: rgba(251,191,36,0.7); }
    .breakdown-pct { font-size: 11px; font-weight: 700; width: 34px; text-align: right; color: var(--text2); }
    .breakdown-feedback { font-size: 11px; color: var(--text3); margin-top: 3px; margin-left: 130px; line-height: 1.4; }

    /* Loading */
    .loading {
      text-align: center; padding: 60px 20px; color: var(--text3); font-size: 14px;
    }
    .loading-spinner {
      width: 28px; height: 28px; border-radius: 50%;
      border: 2px solid rgba(139,92,246,0.2); border-top-color: var(--purple);
      animation: spin 0.8s linear infinite; margin: 0 auto 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ‚îÄ‚îÄ KB button ‚îÄ‚îÄ */
    .kb-btn {
      color: var(--text2); font-family: inherit;
      font-size: 12px; font-weight: 500;
      padding: 5px 12px; border-radius: 8px;
      background: var(--surface); border: 1px solid var(--border);
      white-space: nowrap; cursor: pointer;
      transition: all 0.15s;
    }
    .kb-btn:hover { background: var(--surface2); color: var(--text); border-color: var(--border2); }

    /* ‚îÄ‚îÄ Knowledge modal ‚îÄ‚îÄ */
    .k-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.75); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; z-index: 100; padding: 20px; }
    .k-overlay.hidden { display: none; }
    .k-modal { background: #1e1e1e; border: 1px solid var(--border2); border-radius: 20px; padding: 28px; max-width: 520px; width: 100%; max-height: 85vh; overflow-y: auto; box-shadow: 0 32px 80px rgba(0,0,0,0.6); }
    .k-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
    .k-header h2 { font-size: 18px; font-weight: 700; letter-spacing: -0.4px; }
    .k-header p  { font-size: 12px; color: var(--text2); margin-top: 4px; line-height: 1.5; }
    .k-close { background: var(--surface); border: 1px solid var(--border); color: var(--text2); width: 30px; height: 30px; border-radius: 8px; font-size: 14px; cursor: pointer; flex-shrink: 0; }
    .k-close:hover { background: var(--surface2); color: var(--text); }
    .k-tabs { display: flex; gap: 4px; background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 4px; margin-bottom: 18px; }
    .k-tab { flex: 1; padding: 8px; border-radius: 7px; border: none; background: none; color: var(--text2); font-size: 13px; font-weight: 500; cursor: pointer; font-family: inherit; transition: all 0.15s; }
    .k-tab.active { background: var(--surface2); color: var(--text); border: 1px solid var(--border2); }
    .k-panel { display: none; }
    .k-panel.active { display: block; }
    .k-drop-zone { border: 2px dashed var(--border2); border-radius: 12px; padding: 32px 20px; text-align: center; cursor: pointer; transition: all 0.15s; margin-bottom: 12px; }
    .k-drop-zone:hover, .k-drop-zone.drag-over { border-color: var(--purple); background: rgba(139,92,246,0.05); }
    .k-drop-icon { font-size: 32px; margin-bottom: 10px; }
    .k-drop-text { font-size: 14px; color: var(--text2); }
    .k-drop-sub  { font-size: 12px; color: var(--text3); margin-top: 4px; }
    .k-label { font-size: 12px; font-weight: 600; color: var(--text2); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
    .k-input { width: 100%; background: var(--surface); border: 1px solid var(--border2); color: var(--text); border-radius: 10px; padding: 11px 14px; font-size: 14px; outline: none; font-family: inherit; margin-bottom: 12px; }
    .k-input:focus { border-color: var(--purple); box-shadow: 0 0 0 3px rgba(139,92,246,0.12); }
    .k-input::placeholder { color: var(--text3); }
    .k-textarea { width: 100%; background: var(--surface); border: 1px solid var(--border2); color: var(--text); border-radius: 10px; padding: 11px 14px; font-size: 13px; line-height: 1.55; outline: none; font-family: inherit; resize: vertical; min-height: 120px; margin-bottom: 12px; }
    .k-textarea:focus { border-color: var(--purple); box-shadow: 0 0 0 3px rgba(139,92,246,0.12); }
    .k-textarea::placeholder { color: var(--text3); }
    .k-add-btn { width: 100%; background: linear-gradient(135deg, var(--purple2), var(--purple)); color: white; border: none; padding: 12px; border-radius: 10px; font-size: 14px; font-weight: 700; cursor: pointer; font-family: inherit; box-shadow: 0 4px 14px var(--purple-glow); }
    .k-add-btn:hover { box-shadow: 0 6px 20px rgba(139,92,246,0.5); }
    .k-add-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .k-divider { font-size: 11px; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text3); font-weight: 600; margin: 20px 0 12px; }
    .k-file-list { display: flex; flex-direction: column; gap: 8px; }
    .k-file-item { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 12px 14px; display: flex; gap: 12px; align-items: flex-start; }
    .k-file-icon { font-size: 20px; flex-shrink: 0; margin-top: 1px; }
    .k-file-info { flex: 1; min-width: 0; }
    .k-file-name { font-size: 13px; font-weight: 600; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .k-file-preview { font-size: 11px; color: var(--text3); margin-top: 3px; line-height: 1.4; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .k-file-del { background: none; border: none; color: var(--text3); font-size: 16px; cursor: pointer; flex-shrink: 0; padding: 0 2px; line-height: 1; }
    .k-file-del:hover { color: var(--red); }
    .k-empty { text-align: center; padding: 20px; color: var(--text3); font-size: 13px; }
    .k-loading { text-align: center; padding: 16px; color: var(--text3); font-size: 13px; }
  </style>
</head>
<body>

<div class="header">
  <div class="header-brand">
    <div class="brand-dot"></div>
    <div class="header-title">
      <h1>D2D Coach</h1>
      <p>Session Hub</p>
    </div>
  </div>
  <div class="header-right">
    <span class="rep-badge" id="repBadge"></span>
    <button class="kb-btn" onclick="openKB()">üìö Scripts</button>
    <a href="/" class="practice-btn">‚ñ∂ Practice</a>
  </div>
</div>

<div class="main">

  <!-- Name prompt -->
  <div id="namePrompt" style="display:none;">
    <div class="name-prompt">
      <div class="name-prompt-icon">üìä</div>
      <h2>Load your sessions</h2>
      <p>Enter the name you used during practice to view your history and progress.</p>
      <div class="name-row">
        <input class="name-input" id="hubNameInput" type="text" placeholder="Your first name" maxlength="40"
          onkeydown="if(event.key==='Enter') hubSubmitName()">
        <button class="name-submit" onclick="hubSubmitName()">Load</button>
      </div>
    </div>
  </div>

  <!-- Progress -->
  <div id="progressSection" style="display:none; margin-bottom: 20px;">
    <div class="section-title">Your Progress</div>
    <div class="progress-section">
      <div class="stats-row" id="statsRow"></div>
      <div id="chartWrap"></div>
    </div>
  </div>

  <!-- Sessions -->
  <div id="sessionsHeader" style="display:none;" class="section-title">Past Sessions</div>
  <div class="sessions-section" id="sessionsList"></div>

</div>

<!-- Knowledge base modal -->
<div class="k-overlay hidden" id="kbModal">
  <div class="k-modal">
    <div class="k-header">
      <div>
        <h2>Knowledge Base</h2>
        <p>Upload scripts and training docs ‚Äî the coach will reference them during sessions.</p>
      </div>
      <button class="k-close" onclick="closeKB()">‚úï</button>
    </div>

    <div class="k-tabs">
      <button class="k-tab active" id="tabUpload" onclick="switchTab('upload')">üìÅ Upload File</button>
      <button class="k-tab" id="tabPaste"  onclick="switchTab('paste')">‚úèÔ∏è Paste Text</button>
    </div>

    <div class="k-panel active" id="panelUpload">
      <div class="k-drop-zone" id="dropZone"
        onclick="document.getElementById('fileInput').click()"
        ondragover="event.preventDefault(); this.classList.add('drag-over')"
        ondragleave="this.classList.remove('drag-over')"
        ondrop="handleDrop(event)">
        <div class="k-drop-icon">üìÑ</div>
        <div class="k-drop-text">Drop a .txt or .md file here</div>
        <div class="k-drop-sub">or click to browse</div>
      </div>
      <input type="file" id="fileInput" accept=".txt,.md,.csv" style="display:none" onchange="handleFileSelect(event)">
    </div>

    <div class="k-panel" id="panelPaste">
      <div class="k-label">Document name</div>
      <input class="k-input" id="pasteFilename" type="text" placeholder="e.g. Cold Door Script, Objection Guide‚Ä¶" maxlength="80">
      <div class="k-label">Content</div>
      <textarea class="k-textarea" id="pasteContent" placeholder="Paste your sales script, training notes, or any reference material‚Ä¶"></textarea>
      <button class="k-add-btn" id="pasteAddBtn" onclick="savePasted()">Add Document</button>
    </div>

    <div class="k-divider">Saved Documents</div>
    <div class="k-file-list" id="kbFileList"><div class="k-loading">Loading‚Ä¶</div></div>
  </div>
</div>

<script>
  let sessions = [];
  let repName  = localStorage.getItem('d2d_rep_name') || '';

  (function init() {
    if (repName) {
      document.getElementById('repBadge').textContent = repName;
      loadSessions(repName);
    } else {
      document.getElementById('namePrompt').style.display = 'block';
      setTimeout(() => document.getElementById('hubNameInput').focus(), 100);
    }
  })();

  function hubSubmitName() {
    const val = document.getElementById('hubNameInput').value.trim();
    if (!val) return;
    repName = val;
    localStorage.setItem('d2d_rep_name', repName);
    document.getElementById('namePrompt').style.display  = 'none';
    document.getElementById('repBadge').textContent      = repName;
    loadSessions(repName);
  }

  async function loadSessions(name) {
    document.getElementById('sessionsList').innerHTML = `
      <div class="loading">
        <div class="loading-spinner"></div>
        Loading sessions‚Ä¶
      </div>`;
    try {
      const res  = await fetch('/sessions?name=' + encodeURIComponent(name));
      const data = await res.json();
      sessions = data.sessions || [];
      render();
    } catch (_) {
      document.getElementById('sessionsList').innerHTML =
        '<div class="no-data"><strong>Could not load sessions</strong>Check your connection and refresh.</div>';
    }
  }

  function render() {
    if (sessions.length > 0) {
      document.getElementById('progressSection').style.display = 'block';
      document.getElementById('sessionsHeader').style.display  = 'block';
    }
    renderStats(); renderChart(); renderSessions();
  }

  // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function scoreColor(n) {
    if (n >= 85) return 'gold';
    if (n >= 70) return 'green';
    if (n >= 50) return 'orange';
    return 'red';
  }
  function fmt(isoDate) {
    return new Date(isoDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  }
  function fmtDuration(secs) {
    if (!secs) return '';
    const m = Math.floor(secs / 60), s = secs % 60;
    return m > 0 ? `${m}m ${s}s` : `${s}s`;
  }
  function esc(t) {
    return (t || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  // ‚îÄ‚îÄ Stats ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderStats() {
    const el = document.getElementById('statsRow');
    if (sessions.length === 0) {
      el.innerHTML = '<p style="width:100%;text-align:center;color:var(--text3);padding:10px 0;font-size:13px;">No sessions yet ‚Äî start practicing!</p>';
      return;
    }
    const scores = sessions.map(s => s.analysis.overall);
    const avg    = Math.round(scores.reduce((a,b) => a+b, 0) / scores.length);
    const best   = Math.max(...scores);
    const latest = scores[0];
    const trend  = scores.length >= 2 ? latest - scores[1] : null;
    el.innerHTML = `
      <div class="stat-box"><div class="stat-num ${scoreColor(latest)}">${latest}%</div><div class="stat-label">Latest</div></div>
      <div class="stat-box"><div class="stat-num ${scoreColor(avg)}">${avg}%</div><div class="stat-label">Average</div></div>
      <div class="stat-box"><div class="stat-num ${scoreColor(best)}">${best}%</div><div class="stat-label">Best</div></div>
      <div class="stat-box">
        <div class="stat-num ${trend === null ? '' : trend >= 0 ? 'green' : 'red'}">
          ${trend === null ? '‚Äî' : (trend >= 0 ? '+' : '') + trend + '%'}
        </div>
        <div class="stat-label">vs Last</div>
      </div>
      <div class="stat-box"><div class="stat-num">${sessions.length}</div><div class="stat-label">Sessions</div></div>`;
  }

  // ‚îÄ‚îÄ Trend chart ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderChart() {
    const wrap = document.getElementById('chartWrap');
    const pts  = sessions.slice(0, 20).reverse().map(s => s.analysis.overall);
    if (pts.length < 2) { wrap.innerHTML = ''; return; }
    const W = 600, H = 70, PAD = 6;
    const xStep = (W - PAD * 2) / (pts.length - 1);
    const coords = pts.map((v, i) => ({ x: PAD + i * xStep, y: PAD + (1 - v / 100) * (H - PAD * 2) }));
    const polyline = coords.map(c => `${c.x},${c.y}`).join(' ');
    const area = [...coords.map(c => `${c.x},${c.y}`), `${coords[coords.length-1].x},${H}`, `${coords[0].x},${H}`].join(' ');
    const dots = coords.map(c => `<circle cx="${c.x}" cy="${c.y}" r="3.5" fill="${dotColor(pts[coords.indexOf(c)])}" stroke="#161616" stroke-width="2"/>`).join('');
    wrap.innerHTML = `
      <svg class="trend" viewBox="0 0 ${W} ${H}" preserveAspectRatio="none">
        <defs>
          <linearGradient id="grad" x1="0" y1="0" x2="0" y2="1">
            <stop offset="0%" stop-color="#8b5cf6" stop-opacity="0.3"/>
            <stop offset="100%" stop-color="#8b5cf6" stop-opacity="0"/>
          </linearGradient>
        </defs>
        <polygon points="${area}" fill="url(#grad)"/>
        <polyline fill="none" stroke="#8b5cf6" stroke-width="2" stroke-linejoin="round" points="${polyline}"/>
        ${dots}
      </svg>
      <div class="chart-label"><span>Oldest</span><span>Most Recent</span></div>`;
  }

  function dotColor(score) {
    if (score >= 85) return '#fbbf24';
    if (score >= 70) return '#10b981';
    if (score >= 50) return '#fb923c';
    return '#ef4444';
  }

  // ‚îÄ‚îÄ Sessions list ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderSessions() {
    const list = document.getElementById('sessionsList');
    if (sessions.length === 0) {
      list.innerHTML = `<div class="no-data"><strong>No sessions yet</strong>Head to Practice, finish a session, and it'll appear here.</div>`;
      return;
    }
    list.innerHTML = sessions.map((s, i) => {
      const a  = s.analysis;
      const cl = scoreColor(a.overall);
      const bd = a.breakdown || {};
      const cats = [
        ['Opening',            bd.opening],
        ['Objection Handling', bd.objectionHandling],
        ['Rapport',            bd.rapport],
        ['Tonality',           bd.tonality],
        ['Timing',             bd.timing],
        ['Closing',            bd.closing],
      ];
      const barsHtml = cats.filter(([,v]) => v).map(([label, v]) => `
        <div>
          <div class="breakdown-row">
            <div class="breakdown-label">${label}</div>
            <div class="bar-track"><div class="bar-fill ${scoreColor(v.score)}" style="width:${v.score}%"></div></div>
            <div class="breakdown-pct">${v.score}%</div>
          </div>
          ${v.feedback ? `<div class="breakdown-feedback">${esc(v.feedback)}</div>` : ''}
        </div>`).join('');
      const meta = [fmt(s.date), s.repMessages ? `${s.repMessages} turn${s.repMessages !== 1 ? 's' : ''}` : '', fmtDuration(s.duration)].filter(Boolean).join(' ¬∑ ');
      return `
        <div class="session-card" id="card-${i}" onclick="toggleCard(${i})">
          <div class="card-header">
            <div class="score-circle ${cl}">${a.overall}%</div>
            <div class="card-meta">
              <div class="card-date">${fmt(s.date)}</div>
              <div class="card-turns">${meta}</div>
              <div class="card-summary">${esc(a.summary || '')}</div>
            </div>
            <div class="expand-icon">‚åÑ</div>
          </div>
          <div class="card-body">
            <div class="key-points">
              ${a.keyStrength    ? `<div class="key-point strength"><strong>üí™ Strength</strong>${esc(a.keyStrength)}</div>` : ''}
              ${a.keyImprovement ? `<div class="key-point improve"><strong>üéØ Work On</strong>${esc(a.keyImprovement)}</div>` : ''}
            </div>
            <div class="breakdown-grid">${barsHtml}</div>
          </div>
        </div>`;
    }).join('');
  }

  function toggleCard(i) {
    document.getElementById(`card-${i}`).classList.toggle('open');
  }

  // ‚îÄ‚îÄ Knowledge base ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function openKB() {
    document.getElementById('kbModal').classList.remove('hidden');
    loadKBFiles();
  }
  function closeKB() { document.getElementById('kbModal').classList.add('hidden'); }

  function switchTab(tab) {
    document.getElementById('tabUpload').classList.toggle('active', tab === 'upload');
    document.getElementById('tabPaste').classList.toggle('active',  tab === 'paste');
    document.getElementById('panelUpload').classList.toggle('active', tab === 'upload');
    document.getElementById('panelPaste').classList.toggle('active',  tab === 'paste');
  }

  async function loadKBFiles() {
    const list = document.getElementById('kbFileList');
    list.innerHTML = '<div class="k-loading">Loading‚Ä¶</div>';
    try {
      const res  = await fetch('/knowledge-files');
      const data = await res.json();
      if (!data.files || data.files.length === 0) {
        list.innerHTML = '<div class="k-empty">No documents yet. Upload one above.</div>';
        return;
      }
      list.innerHTML = data.files.map(f => `
        <div class="k-file-item" id="kf-${f.id}">
          <div class="k-file-icon">üìÑ</div>
          <div class="k-file-info">
            <div class="k-file-name">${esc(f.filename)}</div>
            <div class="k-file-preview">${esc(f.preview)}‚Ä¶</div>
          </div>
          <button class="k-file-del" onclick="deleteKBFile(${f.id})" title="Delete">‚úï</button>
        </div>`).join('');
    } catch (_) {
      list.innerHTML = '<div class="k-empty">Could not load files.</div>';
    }
  }

  async function deleteKBFile(id) {
    if (!confirm('Delete this document?')) return;
    try {
      await fetch('/knowledge-file/' + id, { method: 'DELETE' });
      const el = document.getElementById('kf-' + id);
      if (el) el.remove();
      const list = document.getElementById('kbFileList');
      if (!list.querySelector('.k-file-item')) list.innerHTML = '<div class="k-empty">No documents yet.</div>';
    } catch (_) { alert('Failed to delete.'); }
  }

  function handleDrop(e) {
    e.preventDefault();
    document.getElementById('dropZone').classList.remove('drag-over');
    const file = e.dataTransfer.files[0];
    if (file) processFile(file);
  }

  function handleFileSelect(e) {
    const file = e.target.files[0];
    if (file) processFile(file);
    e.target.value = '';
  }

  function processFile(file) {
    const reader = new FileReader();
    reader.onload = async (e) => { await uploadKBFile(file.name, e.target.result); };
    reader.readAsText(file);
  }

  async function savePasted() {
    const filename = document.getElementById('pasteFilename').value.trim();
    const content  = document.getElementById('pasteContent').value.trim();
    if (!filename || !content) { alert('Please fill in both the name and content.'); return; }
    await uploadKBFile(filename, content);
    document.getElementById('pasteFilename').value = '';
    document.getElementById('pasteContent').value  = '';
  }

  async function uploadKBFile(filename, content) {
    const btn = document.getElementById('pasteAddBtn');
    if (btn) btn.disabled = true;
    try {
      const res  = await fetch('/knowledge-file', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ filename, content }),
      });
      const data = await res.json();
      if (data.success) { await loadKBFiles(); switchTab('upload'); }
      else alert('Failed to save: ' + (data.error || 'Unknown error'));
    } catch (_) { alert('Failed to upload file.'); }
    finally { if (btn) btn.disabled = false; }
  }
</script>
</body>
</html>
